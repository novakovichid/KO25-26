<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22%3E%F0%9F%A7%91%E2%80%8D%F0%9F%94%AC%3C/text%3E%3C/svg%3E">
  <title>Matrix Puzzle</title>
  <script src="../section-auth.js"></script>
  <script>window.SectionAuth && window.SectionAuth.guardPage("MORSE");</script>
  <style>
    :root { --bg:#f3f4f6; --panel:#fff; --text:#111827; --muted:#6b7280; --border:#d1d5db; --accent:#0f766e; --ok:#166534; --ok-bg:#dcfce7; --warn:#92400e; --warn-bg:#fef3c7; --cell-size:42px; --gap:6px; }
    * { box-sizing:border-box; }
    body { margin:0; min-height:100vh; font-family:"Segoe UI","Noto Sans",sans-serif; background:radial-gradient(circle at 20% 0%,#fff,var(--bg)); color:var(--text); display:grid; place-items:center; padding:20px; }
    .app { width:min(1280px,100%); background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 14px 30px rgba(17,24,39,.09); padding:16px; display:grid; gap:12px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button { border:1px solid var(--border); background:#fff; color:var(--text); border-radius:10px; padding:8px 12px; font:inherit; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .counter { margin-left:auto; font-weight:700; padding:8px 12px; border:1px solid var(--border); border-radius:10px; }
    .status { border-radius:10px; padding:9px 12px; font-weight:600; }
    .status.ok { color:var(--ok); background:var(--ok-bg); border:1px solid #86efac; }
    .status.progress { color:var(--warn); background:var(--warn-bg); border:1px solid #fcd34d; }
    .codeword { border:1px dashed #86efac; border-radius:10px; padding:9px 12px; background:#f0fdf4; color:#166534; font-weight:700; }
    .auth { border:1px solid var(--border); border-radius:12px; background:#fcfcfd; padding:14px; display:grid; gap:10px; }    .grid-wrap { overflow:auto; border:1px solid var(--border); border-radius:12px; background:#fafafa; padding:12px; min-height:300px; }
    .grid { display:grid; gap:var(--gap); width:max-content; margin:0 auto; }
    .cell { width:var(--cell-size); height:var(--cell-size); border-radius:9px; border:1px solid #9ca3af; background:#fff; color:#111827; display:grid; place-items:center; font-weight:700; cursor:pointer; user-select:none; }
    .cell.one { background:#111827; color:#fff; border-color:#111827; }
    .error { background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:10px; padding:10px 12px; font-weight:600; }
  </style>
</head>
<body>
  <main class="app" id="app">    <div id="gameArea" hidden>
      <section class="toolbar"><button id="restart" class="primary">Заново</button><button id="undo">Отменить</button><button id="redo">Повторить</button><div class="counter" id="stepCounter">Шаги: 0</div></section>
      <div id="status" class="status progress">В процессе</div>
      <div id="codeWordBox" class="codeword" hidden></div>
      <section class="grid-wrap"><div id="grid" class="grid" aria-label="Поле задачи"></div></section>
    </div>
  </main>
  <script>
    const EMBEDDED_TOKEN = "aHtgKa1FX-miAGQrBC2ZQc-IjUnkiYn0kA";
    const URL_CIPHER_KEY = "matrix-1-0-lite-key";
    const appEl=document.getElementById("app"),gameAreaEl=document.getElementById("gameArea"),restartBtn=document.getElementById("restart"),undoBtn=document.getElementById("undo"),redoBtn=document.getElementById("redo"),stepCounterEl=document.getElementById("stepCounter"),statusEl=document.getElementById("status"),codeWordBoxEl=document.getElementById("codeWordBox"),gridEl=document.getElementById("grid");
    let n=0,initialBoard=[],board=[],history=[],historyIndex=0,requiresPassword=false,authSalt=0,authHash=0,revealCodeWord="",codeWordCipher=null,codeWordCipherSalt=0,codeWordCipherCheck=0,codeWordKey32=0,codeWordKeyReady=false;
    function decodeBase64Url(str){const padded=str.replace(/-/g,'+').replace(/_/g,'/')+'==='.slice((str.length+3)%4);const bin=atob(padded);const out=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)out[i]=bin.charCodeAt(i);return out;}
    function obfuscateBytes(bytes,keyText){const key=new TextEncoder().encode(keyText);const out=new Uint8Array(bytes.length);for(let i=0;i<bytes.length;i++)out[i]=bytes[i]^key[i%key.length]^((i*31)&255);return out;}
    function readUint32LE(bytes,o){return((bytes[o])|(bytes[o+1]<<8)|(bytes[o+2]<<16)|(bytes[o+3]<<24))>>>0;}
    function passwordHash32(password,salt32){const data=new TextEncoder().encode(password);let h=(0x811c9dc5^salt32)>>>0;for(let i=0;i<data.length;i++){h^=data[i];h=Math.imul(h,0x01000193)>>>0;h^=h>>>13;}h^=data.length>>>0;h=Math.imul(h,0x85ebca6b)>>>0;h^=h>>>16;return h>>>0;}
    function hashBytes32(bytes,salt32){let h=(0x811c9dc5^salt32)>>>0;for(let i=0;i<bytes.length;i++){h^=bytes[i];h=Math.imul(h,0x01000193)>>>0;h^=h>>>13;}h^=bytes.length>>>0;h=Math.imul(h,0x85ebca6b)>>>0;h^=h>>>16;return h>>>0;}
    function xorWithStream(bytes,seed32){let s=(seed32^0x9e3779b9)>>>0;const out=new Uint8Array(bytes.length);for(let i=0;i<bytes.length;i++){s^=(s<<13)>>>0;s^=s>>>17;s^=(s<<5)>>>0;out[i]=bytes[i]^(s&255);}return out;}
    function tryDecryptCodeWord(){if(!codeWordCipher||!codeWordKeyReady)return"";const plain=xorWithStream(codeWordCipher,codeWordKey32);const check=hashBytes32(plain,(codeWordCipherSalt^0x9e3779b9)>>>0);if(check!==codeWordCipherCheck)return"";try{return new TextDecoder().decode(plain);}catch(_){return"";}}
    function copyBoard(src){return src.map(r=>r.slice());}
    function isUniform(src){const b=src[0][0];for(let r=0;r<src.length;r++)for(let c=0;c<src.length;c++)if(src[r][c]!==b)return false;return true;}
    function targetBit(src){return src[0][0];}
    function toggleCell(r,c){if(r<0||r>=n||c<0||c>=n)return;board[r][c]^=1;}
    function applyMove(r,c){for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++)toggleCell(r+dr,c+dc);}
    function updateStatus(){const solved=isUniform(board);if(solved&&!revealCodeWord&&codeWordCipher)revealCodeWord=tryDecryptCodeWord();statusEl.className='status '+(solved?'ok':'progress');statusEl.textContent=solved?('Решено: все '+targetBit(board)):'В процессе';if(solved&&revealCodeWord){codeWordBoxEl.hidden=false;codeWordBoxEl.textContent='Кодовое слово: '+revealCodeWord;}else{codeWordBoxEl.hidden=true;codeWordBoxEl.textContent='';}stepCounterEl.textContent='Шаги: '+historyIndex;undoBtn.disabled=historyIndex===0;redoBtn.disabled=historyIndex>=history.length;}
    function renderGrid(){gridEl.style.gridTemplateColumns='repeat('+n+', var(--cell-size))';gridEl.innerHTML='';for(let r=0;r<n;r++)for(let c=0;c<n;c++){const b=document.createElement('button');b.type='button';b.className='cell '+(board[r][c]?'one':'');b.textContent=String(board[r][c]);b.addEventListener('click',()=>{if(historyIndex<history.length)history=history.slice(0,historyIndex);applyMove(r,c);history.push({r:r,c:c});historyIndex++;render();});gridEl.appendChild(b);}}
    function render(){renderGrid();updateStatus();}
    function parseCompactPayload(raw){if(raw.length<4)throw new Error('Слишком короткий payload.');const version=raw[0];if(version!==2&&version!==3&&version!==4&&version!==5)throw new Error('Не compact payload.');const parsedN=raw[1];if(!Number.isInteger(parsedN)||parsedN<2||parsedN>20)throw new Error('Некорректный размер поля.');const total=parsedN*parsedN,bitsBytes=Math.ceil(total/8),need=4+bitsBytes+(version>=3?8:0);if(raw.length<need)throw new Error('Неполный payload.');const parsedBoard=[];let k=0;for(let r=0;r<parsedN;r++){const row=[];for(let c=0;c<parsedN;c++){row.push((raw[4+(k>>>3)]>>>(k&7))&1);k++;}parsedBoard.push(row);}if(isUniform(parsedBoard))throw new Error('Задача уже решена.');n=parsedN;initialBoard=copyBoard(parsedBoard);board=copyBoard(parsedBoard);history=[];historyIndex=0;requiresPassword=false;authSalt=0;authHash=0;revealCodeWord='';codeWordCipher=null;codeWordCipherSalt=0;codeWordCipherCheck=0;codeWordKey32=0;codeWordKeyReady=false;if(version>=3){let tail=4+bitsBytes;authSalt=readUint32LE(raw,tail);authHash=readUint32LE(raw,tail+4);requiresPassword=true;tail+=8;if(version===4){const wl=raw[tail];revealCodeWord=new TextDecoder().decode(raw.subarray(tail+1,tail+1+wl));}else if(version===5){codeWordCipherSalt=readUint32LE(raw,tail);codeWordCipherCheck=readUint32LE(raw,tail+4);const wl=raw[tail+8];codeWordCipher=raw.slice(tail+9,tail+9+wl);}}}
    function loadFromEmbedded(){if(!EMBEDDED_TOKEN)throw new Error('Нет зашитой задачи.');const mixed=decodeBase64Url(EMBEDDED_TOKEN);const raw=obfuscateBytes(mixed,URL_CIPHER_KEY);parseCompactPayload(raw);}
    restartBtn.addEventListener('click',()=>{board=copyBoard(initialBoard);history=[];historyIndex=0;render();});
    undoBtn.addEventListener('click',()=>{if(historyIndex<=0)return;const m=history[historyIndex-1];applyMove(m.r,m.c);historyIndex--;render();});
    redoBtn.addEventListener('click',()=>{if(historyIndex>=history.length)return;const m=history[historyIndex];applyMove(m.r,m.c);historyIndex++;render();});
    try{loadFromEmbedded();gameAreaEl.hidden=false;render();}catch(err){appEl.innerHTML='<div class="error">Ошибка загрузки задачи: '+String(err.message||err)+'</div>';}
  </script>
</body>
</html>
