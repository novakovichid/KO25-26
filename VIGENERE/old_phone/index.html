<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22%3E%F0%9F%A7%91%E2%80%8D%F0%9F%94%AC%3C/text%3E%3C/svg%3E">
  <script src="../../section-auth.js"></script>
  <script>window.SectionAuth && window.SectionAuth.guardPage("VIGENERE");</script>
  <title>Старый телефон</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .phone-btn:active {
      transform: translateY(1px);
    }
  </style>
</head>
<body class="min-h-screen bg-slate-100 text-slate-900">
  <main class="mx-auto flex min-h-screen w-full max-w-6xl items-center px-4 py-10 sm:px-6">
    <section class="w-full rounded-3xl border border-slate-200 bg-white p-8 shadow-xl">
      <h1 class="text-2xl font-black tracking-tight">Старый телефон</h1>
      <div class="mt-6 grid gap-6 xl:grid-cols-[360px_minmax(0,1fr)]">
        <section class="rounded-2xl border border-slate-200 bg-slate-50 p-4 sm:p-5">
          <div class="rounded-3xl border border-slate-300 bg-slate-900 p-4 text-slate-100 shadow-inner">
            <div class="rounded-2xl border border-lime-300/40 bg-lime-100 px-3 py-3 text-slate-900">
              <div id="phoneDisplay" class="min-h-8 break-all font-mono text-lg"> </div>
            </div>

            <div class="mt-4 rounded-2xl border border-slate-700 bg-slate-800 p-3">
              <div id="phoneCode" class="min-h-6 break-all font-mono text-sm text-cyan-300"> </div>
            </div>

            <div class="mt-5 grid grid-cols-2 gap-3">
              <button type="button" class="phone-btn rounded-2xl border border-slate-500 bg-slate-700 px-2 py-3 text-center shadow transition hover:bg-slate-600" data-key="1">
                <div class="text-[28px] font-black leading-none">1</div>
                <div class="mt-0.5 font-mono text-sm tracking-[0.2em] text-slate-200">ABC</div>
              </button>
              <button type="button" class="phone-btn rounded-2xl border border-slate-500 bg-slate-700 px-2 py-3 text-center shadow transition hover:bg-slate-600" data-key="2">
                <div class="text-[28px] font-black leading-none">2</div>
                <div class="mt-0.5 font-mono text-sm tracking-[0.2em] text-slate-200">DEF</div>
              </button>
            </div>

            <button id="phoneClear" type="button" class="mt-4 w-full rounded-xl border border-slate-500 bg-slate-800 px-3 py-2 text-sm font-semibold text-slate-100 transition hover:bg-slate-700">
              Очистить
            </button>
          </div>
        </section>

        <section class="rounded-2xl border border-slate-200 bg-slate-50 p-4 sm:p-5">
          <div class="flex justify-center rounded-xl border border-slate-200 bg-white p-3">
            <img
              src="./old_phone.jpg"
              alt="Старый телефон"
              class="h-auto max-h-[700px] w-auto max-w-full rounded-lg object-contain"
            >
          </div>
        </section>
      </div>
      <a href="../index.html" class="mt-8 inline-flex items-center rounded-xl bg-slate-700 px-4 py-2 text-sm font-semibold text-white transition hover:bg-slate-800">Назад в меню Виженера</a>
    </section>
  </main>
  <script>
    (function () {
      const KEYMAP = {
        "1": ["A", "B", "C"],
        "2": ["D", "E", "F"]
      };
      const LETTER_TO_PRESS_CODE = {
        A: "1", B: "11", C: "111",
        D: "2", E: "22", F: "222"
      };
      // Программный переключатель таймаута мультинажатия: UI не показываем.
      const CONFIG = {
        timeoutEnabled: false,
        timeoutMs: 1200
      };

      const displayEl = document.getElementById("phoneDisplay");
      const codeEl = document.getElementById("phoneCode");
      const clearBtn = document.getElementById("phoneClear");
      const buttons = Array.from(document.querySelectorAll("[data-key]"));
      if (!displayEl || !codeEl || !buttons.length) return;

      let text = "";
      let activeKey = "";
      let activeIndex = -1;
      let activeExpiresAt = 0;
      let timerId = 0;

      function render() {
        displayEl.textContent = text || " ";
        codeEl.textContent = (text.split("").map((ch) => LETTER_TO_PRESS_CODE[ch] || "").join("")) || " ";
      }

      function clearComposeState() {
        activeKey = "";
        activeIndex = -1;
        activeExpiresAt = 0;
        if (timerId) {
          clearTimeout(timerId);
          timerId = 0;
        }
      }

      function restartTimeout() {
        if (!CONFIG.timeoutEnabled) return;
        if (timerId) clearTimeout(timerId);
        activeExpiresAt = Date.now() + CONFIG.timeoutMs;
        timerId = window.setTimeout(() => {
          clearComposeState();
        }, CONFIG.timeoutMs);
      }

      function isActiveExpired() {
        if (!CONFIG.timeoutEnabled) return false;
        return !!activeKey && Date.now() > activeExpiresAt;
      }

      function appendNewLetter(key, letters) {
        activeKey = key;
        activeIndex = 0;
        text += letters[activeIndex];
        restartTimeout();
      }

      function cycleLastLetter(letters) {
        if (!text) return;
        activeIndex = (activeIndex + 1) % letters.length;
        text = text.slice(0, -1) + letters[activeIndex];
        restartTimeout();
      }

      function pressKey(key) {
        const letters = KEYMAP[key];
        if (!letters || !letters.length) return;

        if (isActiveExpired()) clearComposeState();

        if (!activeKey || activeKey !== key) {
          appendNewLetter(key, letters);
          render();
          return;
        }

        cycleLastLetter(letters);
        render();
      }

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => pressKey(btn.dataset.key || ""));
      });

      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          text = "";
          clearComposeState();
          render();
        });
      }

      render();
    })();
  </script>
</body>
</html>
