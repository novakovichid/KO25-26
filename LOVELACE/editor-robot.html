<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22%3E%F0%9F%A7%91%E2%80%8D%F0%9F%94%AC%3C/text%3E%3C/svg%3E">
  <title>–≠–º–æ–¥–∑–∏-—Ä–æ–±–æ—Ç</title>
  <script src="../section-auth.js"></script>
  <script>window.SectionAuth && window.SectionAuth.guardPage("LOVELACE", { requiredProfile: "ROBOT" });</script>
  <style>
    @font-face {
      font-family: "Noto Color Emoji";
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src:
        url("https://cdn.jsdelivr.net/fontsource/fonts/noto-color-emoji@latest/emoji-400-normal.woff2") format("woff2"),
        url("https://cdn.jsdelivr.net/fontsource/fonts/noto-color-emoji@latest/emoji-400-normal.ttf") format("truetype");
    }

    :root {
      --bg: #f3f4f6;
      --panel: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #d1d5db;
      --accent: #2563eb;
      --accent-strong: #1d4ed8;
      --danger-bg: #fee2e2;
      --danger-fg: #991b1b;
      --ok-bg: #dcfce7;
      --ok-fg: #166534;
      --warn-bg: #fef3c7;
      --warn-fg: #92400e;
      --emoji-font: "Noto Color Emoji", "Twemoji Mozilla", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Sans", "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 0%, #ffffff, var(--bg));
      color: var(--text);
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      padding: 20px;
    }

    .app {
      width: min(1320px, 100%);
      margin: 0 auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 14px 30px rgba(17, 24, 39, 0.09);
      display: grid;
      gap: 12px;
    }

    .topbar {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .title {
      margin: 0;
      font-size: clamp(1.35rem, 2vw, 1.8rem);
      font-weight: 900;
      letter-spacing: -0.02em;
    }

    .back-link {
      text-decoration: none;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      background: #fff;
      padding: 8px 12px;
      font-weight: 700;
      transition: 120ms ease;
    }

    .back-link:hover {
      border-color: #9ca3af;
      transform: translateY(-1px);
    }

    .blocks {
      display: grid;
      gap: 12px;
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fcfcfd;
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .panel[hidden] {
      display: none !important;
    }

    h2 {
      margin: 0;
      font-size: 1rem;
      font-weight: 800;
    }

    .block-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .block-num {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      display: inline-grid;
      place-items: center;
      font-size: 12px;
      font-weight: 900;
      background: #dbeafe;
      color: #1d4ed8;
      border: 1px solid #93c5fd;
      flex: 0 0 auto;
    }

    .switchers {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr 1fr;
    }

    .mini-title {
      font-size: 12px;
      font-weight: 800;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #475569;
      margin-bottom: 6px;
    }

    label {
      font-weight: 700;
      font-size: 14px;
    }

    textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      outline: none;
      transition: 120ms ease;
      resize: vertical;
    }

    .text-input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      outline: none;
      transition: 120ms ease;
      font: inherit;
    }

    .text-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .emoji-field {
      font-family: var(--emoji-font);
      font-size: 18px;
      line-height: 1.45;
    }

    .code-editor {
      display: grid;
      grid-template-columns: auto 1fr;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }

    .code-editor:focus-within {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .code-lines {
      width: 84px;
      min-width: 84px;
      border: none;
      border-right: 1px solid #e5e7eb;
      border-radius: 0;
      background: #f8fafc;
      color: #64748b;
      text-align: right;
      resize: none;
      overflow: hidden;
      padding: 10px 8px;
      letter-spacing: 0;
      word-spacing: 0;
      font-variant-ligatures: none;
      user-select: none;
      pointer-events: none;
    }

    .code-lines:focus {
      box-shadow: none;
      border-color: #e5e7eb;
    }

    .code-input {
      min-height: 320px;
      border: none;
      border-radius: 0;
      background: transparent;
    }

    .code-input:focus {
      border-color: transparent;
      box-shadow: none;
    }

    .stdin-input {
      min-height: 84px;
      font-family: "Noto Sans", "Segoe UI", "Noto Color Emoji", "Twemoji Mozilla", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      font-size: 18px;
      line-height: 1.35;
      letter-spacing: 0;
      word-spacing: 0;
      font-variant-ligatures: none;
    }

    .output-box {
      min-height: 140px;
      font-family: "Noto Sans", "Segoe UI", "Noto Color Emoji", "Twemoji Mozilla", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      font-size: 18px;
      line-height: 1.35;
      letter-spacing: 0;
      word-spacing: 0;
      font-variant-ligatures: none;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .examples {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .task-grid,
    .subtask-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .subtask-grid {
      margin-top: 8px;
      min-height: 40px;
    }

    .subtask-grid[hidden] {
      display: none !important;
    }

    .task-text-wrap[hidden] {
      display: none !important;
    }

    .task-text-wrap {
      margin-top: 8px;
      display: grid;
      gap: 6px;
    }

    .task-text-label {
      font-size: 14px;
      font-weight: 700;
    }

    .task-text {
      min-height: 72px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      padding: 10px 12px;
      font-size: 16px;
      line-height: 1.35;
      letter-spacing: 0;
      word-spacing: 0;
      font-variant-ligatures: none;
    }

    .task-text p {
      margin: 0;
    }

    .task-text p + p {
      margin-top: 6px;
    }

    .scenario-wrap {
      display: grid;
      gap: 10px;
    }

    .scenario-tools {
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .scenario-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 700;
      color: #1f2937;
      user-select: none;
      cursor: pointer;
    }

    .scenario-toggle input {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
      cursor: pointer;
      margin: 0;
    }

    .scenario-meta {
      font-size: 13px;
      font-weight: 700;
      color: #334155;
      min-height: 18px;
    }

    .scenario-board {
      border: 1px solid #dbeafe;
      border-radius: 10px;
      background: #f8fafc;
      padding: 10px;
      min-height: 150px;
      overflow: auto;
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      align-items: start;
    }

    .scenario-card {
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: #ffffff;
      padding: 8px;
      display: grid;
      gap: 8px;
      min-width: 0;
    }

    .scenario-card-meta {
      font-size: 12px;
      font-weight: 700;
      color: #334155;
      min-height: 16px;
    }

    .scenario-card-board {
      min-height: 70px;
      overflow: auto;
      padding-bottom: 2px;
    }

    .scenario-grid {
      display: grid;
      gap: 4px;
      width: max-content;
    }

    .scenario-axis {
      width: 38px;
      height: 38px;
      border: 1px dashed #cbd5e1;
      border-radius: 8px;
      background: #f1f5f9;
      display: grid;
      place-items: center;
      font-family: var(--emoji-font);
      font-size: 15px;
      line-height: 1;
      color: #334155;
      user-select: none;
    }

    .scenario-axis.corner {
      border-style: solid;
      background: #e2e8f0;
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      font-size: 10px;
      font-weight: 800;
      letter-spacing: 0.02em;
      line-height: 1.15;
      white-space: pre-line;
      text-align: center;
    }

    .scenario-cell {
      width: 38px;
      height: 38px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background: #ffffff;
      position: relative;
      display: grid;
      place-items: center;
      font-family: var(--emoji-font);
      font-size: 18px;
      line-height: 1;
    }

    .scenario-cell.color-red { background: #fee2e2; }
    .scenario-cell.color-yellow { background: #fef9c3; }
    .scenario-cell.color-green { background: #dcfce7; }
    .scenario-cell.color-purple { background: #f3e8ff; }

    .scenario-cell.blocked {
      background: #e5e7eb;
      border-color: #94a3b8;
      color: #334155;
      font-size: 17px;
    }

    .scenario-cell.finish {
      box-shadow: inset 0 0 0 2px #2563eb;
    }

    .scenario-marker {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      pointer-events: none;
      font-family: var(--emoji-font);
      font-size: 18px;
      line-height: 1;
    }

    .scenario-marker.start {
      font-size: 12px;
      font-weight: 900;
      color: #0f172a;
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      place-items: start;
      padding-top: 2px;
      padding-left: 4px;
      justify-items: start;
      align-items: start;
    }

    .scenario-marker.finish {
      font-size: 12px;
      font-weight: 900;
      color: #1d4ed8;
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      place-items: end;
      padding-bottom: 2px;
      padding-right: 4px;
      justify-items: end;
      align-items: end;
    }

    .scenario-temp {
      position: absolute;
      right: 3px;
      top: 2px;
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      font-size: 10px;
      font-weight: 800;
      color: #475569;
      line-height: 1;
      pointer-events: none;
    }

    .scenario-control {
      position: absolute;
      left: 2px;
      bottom: 2px;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.35);
      background: #94a3b8;
      color: #ffffff;
      display: grid;
      place-items: center;
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      font-size: 8px;
      font-weight: 900;
      line-height: 1;
      pointer-events: none;
      z-index: 1;
    }

    .scenario-control.color-red { background: #ef4444; }
    .scenario-control.color-yellow { background: #f59e0b; }
    .scenario-control.color-green { background: #22c55e; }
    .scenario-control.color-purple { background: #a855f7; }

    .scenario-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 14px;
      align-items: center;
      font-size: 12px;
      font-weight: 700;
      color: #334155;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-chip {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #94a3b8;
      display: inline-grid;
      place-items: center;
      font-size: 12px;
      line-height: 1;
      font-family: var(--emoji-font);
    }

    .legend-chip.red { background: #fee2e2; }
    .legend-chip.yellow { background: #fef9c3; }
    .legend-chip.green { background: #dcfce7; }
    .legend-chip.purple { background: #f3e8ff; }
    .legend-chip.blocked { background: #e5e7eb; }

    .scenario-error {
      color: #991b1b;
      font-weight: 700;
      font-size: 14px;
      padding: 8px;
      border: 1px dashed #fca5a5;
      border-radius: 8px;
      background: #fef2f2;
      width: fit-content;
    }

    .test-label {
      font-size: 13px;
      font-weight: 800;
      color: #334155;
    }

    .test-output-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .test-output-card {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #ffffff;
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .test-output-card.ok {
      border-color: #86efac;
      background: #f0fdf4;
    }

    .test-output-card.error {
      border-color: #fca5a5;
      background: #fef2f2;
    }

    .test-output-card.warn {
      border-color: #fcd34d;
      background: #fffbeb;
    }

    .test-output-meta {
      font-size: 12px;
      font-weight: 700;
      color: #475569;
    }

    button {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      color: var(--text);
      font: inherit;
      font-weight: 700;
      padding: 9px 12px;
      cursor: pointer;
      transition: 120ms ease;
    }

    button:hover {
      border-color: #9ca3af;
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.65;
      cursor: not-allowed;
      transform: none;
    }

    .switchers button[aria-pressed="true"] {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .switchers button[aria-pressed="true"]:hover {
      background: var(--accent-strong);
      border-color: var(--accent-strong);
    }

    button.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    button.primary:hover {
      background: var(--accent-strong);
      border-color: var(--accent-strong);
    }

    .status-box {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-weight: 700;
      background: #f3f4f6;
      color: #1f2937;
      min-height: 44px;
      display: flex;
      align-items: center;
    }

    .status-box.ok {
      background: var(--ok-bg);
      color: var(--ok-fg);
      border-color: #86efac;
    }

    .status-box.error {
      background: var(--danger-bg);
      color: var(--danger-fg);
      border-color: #fca5a5;
    }

    .status-box.warn {
      background: var(--warn-bg);
      color: var(--warn-fg);
      border-color: #fcd34d;
    }

    .step-count {
      font-weight: 700;
      color: #1f2937;
      font-size: 14px;
    }

    .keyboard {
      display: grid;
      gap: 10px;
    }

    .keyboard-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 220px;
      gap: 10px;
      align-items: start;
    }

    .keyboard-left {
      display: grid;
      gap: 10px;
      min-width: 0;
    }

    .emoji-group {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #fff;
      padding: 10px;
    }

    .emoji-group.group-1 { background: linear-gradient(180deg, #ffffff, #f8fafc); }
    .emoji-group.group-2 { background: linear-gradient(180deg, #ffffff, #f9fafb); }
    .emoji-group.group-3 { background: linear-gradient(180deg, #ffffff, #eff6ff); }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
      gap: 6px;
    }

    .emoji-btn {
      font-family: var(--emoji-font);
      font-size: 22px;
      line-height: 1;
      padding: 8px 6px;
      min-height: 40px;
      display: grid;
      place-items: center;
    }

    .editor-nav {
      border: 1px solid #d1d5db;
      border-radius: 10px;
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .nav-title {
      margin: 0;
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      color: #475569;
    }

    .nav-arrows {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      grid-template-areas:
        ". up ."
        "left down right";
      gap: 6px;
    }

    .nav-actions {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
    }

    .nav-btn {
      min-height: 42px;
      padding: 7px 8px;
      display: grid;
      place-items: center;
      font-weight: 800;
      border-radius: 10px;
      user-select: none;
    }

    .nav-btn.up { grid-area: up; }
    .nav-btn.left { grid-area: left; }
    .nav-btn.down { grid-area: down; }
    .nav-btn.right { grid-area: right; }
    .nav-btn.enter { grid-column: 1 / -1; }

    .vars-panel[hidden] {
      display: none !important;
    }

    @media (max-width: 1040px) {
      .switchers {
        grid-template-columns: 1fr;
      }

      .keyboard-layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <header class="topbar">
      <h1 class="title">–≠–º–æ–¥–∑–∏-—Ä–æ–±–æ—Ç</h1>
      <a href="../index.html" class="back-link">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </header>

    <section class="blocks">
      <section class="panel">
        <h2 class="block-title"><span class="block-num">0</span>–ü—Ä–∏–º–µ—Ä—ã –∏ –ó–∞–¥–∞–Ω–∏—è</h2>
        <div class="switchers">
          <section>
            <div class="mini-title">–ü—Ä–∏–º–µ—Ä—ã</div>
            <div class="examples">
              <button id="example1Btn" type="button" aria-pressed="false">–ü—Ä–∏–º–µ—Ä ‚Ññ1</button>
              <button id="example2Btn" type="button" aria-pressed="false">–ü—Ä–∏–º–µ—Ä ‚Ññ2</button>
              <button id="example3Btn" type="button" aria-pressed="false">–ü—Ä–∏–º–µ—Ä ‚Ññ3</button>
              <button id="example4Btn" type="button" aria-pressed="false">–ü—Ä–∏–º–µ—Ä ‚Ññ4</button>
              <button id="example5Btn" type="button" aria-pressed="false">–ü—Ä–∏–º–µ—Ä ‚Ññ5</button>
            </div>
          </section>
          <section>
            <div class="mini-title">–ó–∞–¥–∞–Ω–∏—è</div>
            <div id="taskButtons" class="task-grid">
              <button type="button" data-task="1" aria-pressed="false">–ó–∞–¥–∞–Ω–∏–µ 1</button>
              <button type="button" data-task="2" aria-pressed="false">–ó–∞–¥–∞–Ω–∏–µ 2</button>
              <button type="button" data-task="3" aria-pressed="false">–ó–∞–¥–∞–Ω–∏–µ 3</button>
              <button type="button" data-task="4" aria-pressed="false">–ó–∞–¥–∞–Ω–∏–µ 4</button>
            </div>
            <div id="taskSubtasks" class="subtask-grid" hidden></div>
            <section id="taskTextWrap" class="task-text-wrap" hidden>
              <div class="task-text-label">–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è</div>
              <div id="taskText" class="task-text"></div>
            </section>
          </section>
        </div>
      </section>

      <section class="panel">
        <h2 class="block-title"><span class="block-num">1</span>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞</h2>
        <label for="codeInput">–ö–æ–¥</label>
        <div class="code-editor">
          <textarea id="codeLineNumbers" class="emoji-field code-lines" readonly tabindex="-1" aria-hidden="true">üìå</textarea>
          <textarea id="codeInput" class="emoji-field code-input" spellcheck="false" autocomplete="off" autocapitalize="off"></textarea>
        </div>
      </section>

      <section class="panel">
        <h2 class="block-title"><span class="block-num">2</span>–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞</h2>
        <div id="emojiKeyboard" class="keyboard"></div>
      </section>

      <section class="panel">
        <h2 class="block-title"><span class="block-num">3</span>–ü–æ–ª–µ —Å—Ü–µ–Ω–∞—Ä–∏—è</h2>
        <div class="scenario-wrap">
          <div class="scenario-tools">
            <label class="scenario-toggle" for="scenarioAnimationToggle">
              <input id="scenarioAnimationToggle" type="checkbox" checked>
              –ê–Ω–∏–º–∞—Ü–∏—è —Ä–æ–±–æ—Ç–∞
            </label>
          </div>
          <div id="scenarioMeta" class="scenario-meta"></div>
          <div id="scenarioBoard" class="scenario-board"></div>
          <div class="scenario-legend">
            <span class="legend-item"><span class="legend-chip">ü§ñ</span>–†–æ–±–æ—Ç</span>
            <span class="legend-item"><span class="legend-chip blocked">‚ñ†</span>–°—Ç–µ–Ω–∞</span>
            <span class="legend-item"><span class="legend-chip">S</span>–°—Ç–∞—Ä—Ç</span>
            <span class="legend-item"><span class="legend-chip">F</span>–§–∏–Ω–∏—à</span>
          </div>
        </div>
      </section>

      <section class="panel">
        <h2 class="block-title"><span class="block-num">4</span>–ó–∞–ø—É—Å–∫</h2>
        <div class="controls">
          <button id="runBtn" class="primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
          <button id="resetBtn">–°–±—Ä–æ—Å</button>
        </div>
        <div id="statusBox" class="status-box">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞.</div>
        <div id="stepCount" class="step-count">–°—É–º–º–∞—Ä–Ω—ã–µ —à–∞–≥–∏: 0</div>
      </section>

      <section class="panel" hidden>
        <h2 class="block-title"><span class="block-num">5</span>–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
        <div id="testOutputs" class="test-output-grid"></div>
      </section>

      <section id="codePhrasePanel" class="panel" hidden>
        <h2 class="block-title"><span class="block-num">6</span>–ö–æ–¥–æ–≤–∞—è —Ñ—Ä–∞–∑–∞</h2>
        <label for="codePhraseInput">–ö–æ–¥–æ–≤–∞—è —Ñ—Ä–∞–∑–∞</label>
        <input id="codePhraseInput" class="text-input" type="text" autocomplete="off" autocapitalize="off" spellcheck="false" placeholder="–ö–æ–¥–æ–≤–∞—è —Ñ—Ä–∞–∑–∞" readonly>
        <div class="controls">
          <button id="copyCodePhraseBtn" type="button">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </section>
    </section>

    <section class="vars-panel" hidden>
      <h2>–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö</h2>
      <div id="varsGrid"></div>
    </section>
  </main>

  <script src="./js/lab-shell.js"></script>
  <script src="./js/domain-robot.js"></script>
  <script>
    const KEYCAP_DIGITS = ["0Ô∏è‚É£", "1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£", "9Ô∏è‚É£"];
    const COLOR_CSS_BY_CODE = { red: "color-red", yellow: "color-yellow", green: "color-green", purple: "color-purple" };

    const ROBOT_EXAMPLES = [
      { label: "–ü—Ä–∏–º–µ—Ä ‚Ññ1", code: ["üö∂üö†", "üö∂üöá", "üö∂üöá"].join("\n") },
      { label: "–ü—Ä–∏–º–µ—Ä ‚Ññ2", code: ["üö∂üö†", "üö∂üöá", "üé®üåπ", "üö∂üö†", "üé®üçÄ"].join("\n") },
      { label: "–ü—Ä–∏–º–µ—Ä ‚Ññ3", code: ["üîÅüß±üö†", "üö∂üöá", "üòê", "ü§îüõ§üö†", "üö∂üö†", "üòê", "üé®üåª"].join("\n") },
      { label: "–ü—Ä–∏–º–µ—Ä ‚Ññ4", code: ["ü§îüå°üî•1Ô∏è‚É£0Ô∏è‚É£", "üé®üåπ", "üòê", "ü§îüå°üßä1Ô∏è‚É£0Ô∏è‚É£", "üé®üçÄ", "üòê", "ü§îüå°üü∞1Ô∏è‚É£0Ô∏è‚É£", "üé®üçá", "üòê", "ü§îüéØüåπ", "üö∂‚úàÔ∏è", "üòê", "ü§îüéØüçÄ", "üö∂üö†", "üòê", "ü§îüéØüçá", "üö∂üöá", "üòê", "üé®üçá"].join("\n") },
      { label: "–ü—Ä–∏–º–µ—Ä ‚Ññ5", code: ["ü§îüå°üßäüü∞1Ô∏è‚É£0Ô∏è‚É£", "üé®üåπ", "üòê", "ü§îüéØüåπ", "üîÅüõ§üöá", "üö∂üöá", "üòê", "üòê", "ü§îüå°üî•1Ô∏è‚É£0Ô∏è‚É£", "üîÅüõ§‚úàÔ∏è", "üö∂‚úàÔ∏è", "üòê", "üòê", "üîÇ1Ô∏è‚É£", "ü§îüß±üöú", "üòê", "üòê", "üîÅüõ§üö†", "üö∂üö†", "üòê", "ü§îüèÅ", "üé®üçÄ", "üòê"].join("\n") }
    ];

    const ROBOT_SUBTASK_PRESETS = Object.freeze({
      "1.1": {
        code: [
          "üö∂üö†",
          "üé®üåπ",
          "üö∂üö†",
          "üö∂üöá"
        ].join("\n")
      },
      "1.2": {
        code: [
          "üö∂üö†",
          "üö∂üö†",
          "üé®üçÄ",
          "üö∂üö†",
          "üö∂üöá"
        ].join("\n")
      },
      "1.3": {
        code: [
          "üé®üåª",
          "ü§îüß±üö†",
          "üö∂üöá",
          "üòê",
          "ü§îüõ§üö†",
          "üö∂üö†",
          "üòê"
        ].join("\n")
      },
      "1.4": {
        code: [
          "üîÇ2Ô∏è‚É£",
          "üö∂üö†",
          "üòê",
          "üé®üçá",
          "üîÇ2Ô∏è‚É£",
          "üö∂üö†",
          "üòê",
          "üö∂üöá"
        ].join("\n")
      },
      "2.1": { code: "" },
      "2.2": { code: "" },
      "3.1": {
        code: [
          "üîÇ2Ô∏è‚É£",
          "ü§îüõ§üö†",
          "üö∂üö†",
          "üòê",
          "üòê",
          "ü§îüõ§üöá",
          "üö∂üöá",
          "üòê",
          "ü§îüèÅ",
          "üé®üçá",
          "üòê"
        ].join("\n")
      },
      "3.2": {
        code: [
          "üîÅüõ§üöá",
          "üö∂üöá",
          "üòê",
          "üîÅüõ§üö†",
          "üö∂üö†",
          "üòê",
          "ü§îüèÅ",
          "üé®üåπ",
          "üòê"
        ].join("\n")
      },
      "4.1": { code: "" }
    });

    const ROBOT_SUBTASK_TEXTS = Object.freeze({
      "2.1": ["–ù–∞ –∫–∞–∂–¥–æ–º –∏–∑ 3 –ø–æ–ª–µ–π –¥–æ–π–¥–∏—Ç–µ –¥–æ —Ñ–∏–Ω–∏—à–∞ –∏ –∑–∞–∫—Ä–∞—Å—å—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é –∫–ª–µ—Ç–∫—É –≤ üåπ."],
      "2.2": ["–ù–∞ –∫–∞–∂–¥–æ–º –∏–∑ 3 –ø–æ–ª–µ–π –¥–æ–π–¥–∏—Ç–µ –¥–æ —Ñ–∏–Ω–∏—à–∞ –∏ –∑–∞–∫—Ä–∞—Å—å—Ç–µ –¥–≤–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –∫–ª–µ—Ç–∫–∏: –æ–¥–Ω—É –≤ üçÄ –∏ –æ–¥–Ω—É –≤ üåª."],
      "3.1": ["–ù–∞ –∫–∞–∂–¥–æ–º –∏–∑ 3 –ø–æ–ª–µ–π –¥–æ–π–¥–∏—Ç–µ –¥–æ —Ñ–∏–Ω–∏—à–∞ –∏ –∑–∞–∫—Ä–∞—Å—å—Ç–µ —Ñ–∏–Ω–∏—à–Ω—É—é –∫–ª–µ—Ç–∫—É –≤ üçá."],
      "3.2": ["–ù–∞ –∫–∞–∂–¥–æ–º –∏–∑ 3 –ø–æ–ª–µ–π –¥–æ–π–¥–∏—Ç–µ –¥–æ —Ñ–∏–Ω–∏—à–∞ –∏ –∑–∞–∫—Ä–∞—Å—å—Ç–µ —Ñ–∏–Ω–∏—à–Ω—É—é –∫–ª–µ—Ç–∫—É –≤ üåπ."],
      "4.1": ["–ù–∞ –∫–∞–∂–¥–æ–º –∏–∑ 10 –ø–æ–ª–µ–π-–ª–∞–±–∏—Ä–∏–Ω—Ç–æ–≤ –¥–æ–π–¥–∏—Ç–µ –¥–æ —Ñ–∏–Ω–∏—à–∞ –∏ –∑–∞–∫—Ä–∞—Å—å—Ç–µ –≤ üåπ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –ø–æ–≤–æ—Ä–æ—Ç–∞."]
    });

    const ROBOT_KEYBOARD_GROUPS = [
      ["üö∂", "üé®", "ü§î", "üîÅ", "üîÇ", "üòê"],
      ["‚úàÔ∏è", "üöá", "üö†", "üöú", "üß±", "üõ§", "üèÅ", "üéØ", "üå°", "üåπ", "üåª", "üçÄ", "üçá"],
      ["üü∞", "üö´", "üî•", "üßä", "üî•üü∞", "üßäüü∞", "0Ô∏è‚É£", "1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£", "9Ô∏è‚É£"]
    ];

    const ROBOT_SCENARIO_BLOBS = Object.freeze({
      "example:1": [
        { "seed": 3668005737, "blob": "Epbwb9dNRaBq6adbqPzN8Y1l4aIfQixb7RzGEqdGljzgJ8uE95O1FmMhhyx3HGBBcsHXVGdDyibDr96yybM9yPKp72SIENe/EmjplE4ySatXLaB+L93WyWkJv1z/FE3nrLjBlmJ7rg7404Vsb+t9Tmu5jss=" },
        { "seed": 3273459124, "blob": "z6F1xFICuAuHvULDjcOginDypElaTTHxAKpjqQKZO+c90M7v8twLfU/2IjcSY016z9YSfyLMV83u2LvJrGzQk6+eas8N36oUf7+MD2sNpFAqumUV6tLLYgS+GudaS+C88c/EfWe0E+XVhCB3ihRTddeuy+A=" },
        { "seed": 1136784771, "blob": "+CTeQR3/E+bQWdnlsq7bd+e3TwxVUJoftw7YDN004DrK1aXqvWFlUJlTOVJtTnbH2BM5Oq1RvOCZvcCsc4GLzpgbwUrCogF5qNoXKlTgXy29fw7Q5c9gD7MboUIF5rvhhsoveKgJ+MiCITuSdTltyMHr4CU=" }
      ],
      "example:2": [
        { "seed": 4008025350, "blob": "fY9bDuBU/rE1w/zb39Um4KJcCgNI+3erErV903DvPc3PvqClAApOhz9IXC1AdcvQHTh8tTC6kZf8xqVzntrW+R2wRIW/CWyuzUEyFbkbIrp4FMvf+GQNuBagBB2oveaWgyEqoRP/1ZgmFt8jDSvGyZT6KrIvTy7XPIZlM16aFjndVoqfOIttJ8wMclUzVaZwOdGXhch7jmnbYYICj3Sp" },
        { "seed": 809390253, "blob": "1goU80u5qVSu58O3pCixpUkZBR7jFsAMqRGifqsyysiku+8YayefIictIwB7yNwVNn3zKNuX5vKHo3qexYfhfLY1i/gUZLvLVmQN+EJmtX8T0cTCUwm6Ha0FW7Dz4JGTaCTlHPjSgj098yAONpbRjL8/pS9EYtkyx2M6XoVHIbx208Vik2Y4wlcpTThLqDE10pSYmGOWOcxgxF2vVKle" },
        { "seed": 1688402472, "blob": "U0XpWKbuTM+L167PWb/0TgwWGLUOoWW0DM0PpXbFz6Oh9FJzRvA9OUNSDjvG3xk+c/Juw/bgg4nifJfFmLBk1zP69lN5s95Qc1vgAz/xcBTW3tlpPr4fpgha9uuul5R4betY99WFJybYDA01i4GUp3qwOERplTzJIjxXhVhwpBfznDjJfjHcWXIWIEO3P3Tel5uFM44hnHfFG/B0iV5b" }
      ],
      "example:3": [
        { "seed": 3058276199, "blob": "HLhCtfEL1+q0ttU3zvofCwMLs1i5BN4R02LUeIHApKbuSTlekVUnXD5/NYbRGjJ7/G+F7oGF/vIzwvSp72SODcu2Aj7x9Wg8DadBNLZ1CZqN0SMKshCsE1fArPWAjmhs5UDlzp4reZIpCzeNgN7eN7slUy7BPJxlM16GQyH7UA==" },
        { "seed": 2576199066, "blob": "4ROv4hSQ8tXZzyinixFaBB6gXu8cv3vNfrkJj4SroelTIhSJNE5DIxBEiJEUMXf0YYSomeT+myzemanvHd5ElocsMOnNUHxDsRt+iEtRmtLScQm4CudaRLCv/Y2PfmCVH/DfgysxknUWK5GWmr8+viRIf5NdimwwQMsOIf9IxIt1xn52kw==" },
        { "seed": 1876303921, "blob": "Sv74B4+1zbiiMb/lYFRVGbVN6UqnGqRipWX+iu+u7lQ4D8MsLys+Dij5n1Q/dPhpiqnf/J+bQt6Ll6YqgRuF4CpB54xQaF+nWjDxLAaa0cNvBagWlwVe8aHxh8Q3fLUP9JDJKDzeJhExp5za8ir1cAN1nnKJbygQlEk=" }
      ],
      "example:4": [
        { "seed": 1609243612, "blob": "p6kdnKqKoMNfoPoOJVtIslj6TPECxQm4eJL74erhUz8V2GY3SlQTNZTuWn96+2WCp966h/pEr4XWoCOBBNT4S0ewjE0yFfMVZqo0R4mbiHUJtg7nWg6ntMnPxGhwtx/yyMl0LpIpCzeNgN7PPbYpSWmfPN90LUeMGCHgRMaOadkfZIIaIk04W/RmJM2Uksg80Q==" },
        { "seed": 2163541387, "blob": "8EyGuZXn2z7I5RFLKkbjX+9f91TdaNJlj5eQ5KVcOBLCfX1SNXkriIIrcTr1Zo6v0LvB4iWp9NjhJYgEy6lTJpDVF2gN+Aho8W9fgoaGIxi+E7VCBaq0yc/EaHC3H/LIyXQukikLN42A3s89tilJaZ8833QtR4wYIeBExo5p2R9kghoiTThb9GYkzZSSyDzR" },
        { "seed": 4087913838, "blob": "FdejhvicJqmNDlREN+0O6ErkUotwsw+SivyVqxg3FcVnZhgtGEKVn0QANLVojaPYtcCkPcjyqe9kjg3LtgI+8fVOMlfgA3X/NASajZstTq8bqBAdqPiknrshKqIC4dmIOneKNEA/jZ3f7jCFL0Bvk3uBImVGm0Fmqg/OjnTYL2OtGjwAcFu+MSbIioeGJI5mww==" }
      ],
      "example:5": [
        { "seed": 2867345121, "blob": "mu7It9+lPcjyw+9zsESFqQV9udoXKnTyFXaOOl/e3sRoH7Nc/zsJvvnJz8RvZKgZ+tmPbG/rEk57h5ba8Sv1cHp32WbHOm8ey00hvB+ExW7UMXvMT2FafySoMTPFiJKJNY4hxSfGFrxgp0t0KClk0rSYCbThgvrHtQZVn7PxZOIiI1cxV2KlUE4GJqMDylon" },
        { "seed": 904733842, "blob": "6evnipxoKv0hp5DfE3mSPBY4loeUpwPmZhBR1zyDaTFbmlwhvHadyynscCmMGT8MaRzgMWzmpdvIIsl30naCRYly9lsEd3krmKjeEb+50vvH9FQRzOXlSqZDKUMuQCPrUBMPYaAEhk4pmc4uT9b4yiab/ifkiF0bCOeFNZc2iPx9JXsRRLeqIIh0WQXsqE0=" },
        { "seed": 1946207755, "blob": "cMwGORVnW75IbpHNqsZj32/fd9Rd6FLmDxYQZCXcuJJC/f3StfmuCAer8bp15g4vUDtBYqUpdFhhpQiESynTphBVl+iNeIvoce/fAgcGo5g+kzXChSN5aT5Kr+0/inRfH+zvS+2EsAoaRXWKMqvC5B76R7qrwBzRryTLQQnzQrTIAZm/naDDJvSkWB0ZSLxR" }
      ],
      "task:1.1": [{ "seed": 2850069356, "blob": "F/kNrBpasPPP1so+VetY4siKPCGSdTlpyMPrsXqxI09liHbHOgQAxQVeqg/Ki3XSN26KV2o0X1WmcDPRlITIe/dGkifFB6Jst1cEdzMl3LiSQv39ourD+kxWkv+iY/gUKRd8RiXzHlpWeZ0Wyl94y61nDMyylXKV5jD5kVdFCLvOKZshwsJPNGk=" }],
      "task:1.2": [{ "seed": 2286936027, "blob": "oFy2CUX366640yE7mlazz58vJ8RtWALU34bAdPUsSGKSbY0iZWnaGDLbAYqFdt4/YIsRclVZJKgxNdiUm5ljlkDjKYIaqnmxQFJvcnyYt5VF5+aY3cf4R1uTubot/hM5XnIHI/oeRQdh/DaTBSLTpnkCl+mNeInocfWSVFhYo9Z5mTeF2nxraT4b8A==" }],
      "task:1.3": [
        { "seed": 445038722, "blob": "+dt3+qxYWk0x9QCoY6kCjCboJteE95O2FmEhhyxzGWFLasyRTAYquzu84Jm8ya98mcyQ4Xy2M5X2QUGWghdzSq5VN/EsJuWbiGQUqxumFB2osraFj2NhtBLD2YotPdUrQGOQgcP4dPUpRGCXbcc6BEnLTCG8HITFY5NmO8JXMwBuFvYxbJ+BkoYtw2yceP0Crw==" },
        { "seed": 313296377, "blob": "gibgv0cdVVCaGbcN2AzdIf010dLv8twLfU32IjcWZkxw19tUZ0OlJtCRl/zHrHCRwpGnZNcz+vZTf67CWWMN+GIZ/zQYwMfPYhj5RL5CWfun/ZCOX22mGfnZj2xvxD0XPMjR1fg0uzkDNqBlx3h9CNgYIf8PktY2kz9kghoiTThb/XY60ZeAyDzxZsM=" },
        { "seed": 31717124, "blob": "f7GlVAISSPt3rhK2fdNw+iDC1LnqvWFgUJtTOVJpS3fNwB5/Isw7zf3m8oeic53Kn6Yiz1L8gUMw+/MZSx3uCBmOOl/b0sZtH/lEnj0TsKzsk4NufOVA6p6NJzvZPAoLgZLV9T2zaBt4iWuALH1RjFhv9Q+SvGGTJCnURHxNe1u+I3qfm5iGLt45hCfZGr5lu1QEMBV6xw==" }
      ],
      "task:1.4": [{ "seed": 2640684229, "blob": "vkJM+7PxwdxWPutJzJDJPSHRPRZ73qiGsWiKZgNqknCMczcQ0283qhz1yzjTMGSNHjULIEPfTnqfm5KGLd85hF79U/BsrFNDLjwlgKreTef7mfzKy0FSlbX9c6hbOEkrQGy9EUwYL7VP0nwh0+RpFIe8jTub/mO631tYRu6eecRnkMpgOXgGRPDVOoc=" }],
      "task:2.1": [
        { "seed": 1107345981, "blob": "RloEA7tJuQTeFtNm1HiB1bmp9U5zRvA/OUBSDjvC2hg0a/8o25eO8padM9DLmKwlhg3D+EtHkJwZIXLuYnb/JCCU7J4tXIZSnlQToJS4uNUhOponvZ6IKzncPEBjv66avz2vOkRvjzzfe31UgFpq9UX6gnvSNG6KV2obcAzhP3TenZuGMo4h5X6CB/Az5w8ENGo9iv3eSOH5n/2AowZBk7m6atccMQ==" },
        { "seed": 358992145, "blob": "ah4Yp69V7diCUV8CQPR1udXtCepHuoSCRYXeKo9ODvRYr+NMz4vbrspZv/RfFBgJqkn/HL97pGOlZf6KlvurCwxQ8D05QlIOQpWfRQA0zD7N/uaDieJ8l8WYsGTXM/r2U3mz3lBzW+ADP/FwFNbe2Wk+vh+mCFr2666XlHht61jy2YciJpJ1OSLGi5SnavtoWC7BLMkiPF2FW3GkF4qVf9V+drMILQ==" },
        { "seed": 2468135791, "blob": "FCAK7Wkzn8Ks3W2YRpIn0wuze6ABHBZ5K4uM0Ano/J7m0fEGCa3rtCTXTW5ZMkoj9BdNVnmdNtoLa6ywEBqZofJu4vB/pKAUbB+t3gbSHtKTIRRJT0Tu7SuWYh5RlYgc7YehFBZVafptsYPqEvAM87fgDNXgbshMRaBFrv4L2fKM55Vo4PQHIwxIuQ6hDakChnCzZo+ErqfrVSNekSxnFWsAZPnOCw==" }
      ],
      "task:2.2": [
        { "seed": 1765432109, "blob": "VoqUc8s5KdQuZkM2JKgxJcmZhZ5jlkCPKZAi/iuySkgkO2+Y66ceoqato4D7SFyVtv1zqFsXYGwJccJeckZv9DDEfG7drBYC7qSDcOToCKXRCmp3rc44mymMzDBzTz5Kr+0/inRfH+zvS+2EsAoaRXWKMqvC5B76R7qrwBzRryTOTQv2Qv6xNY7yl6DDN7/0RFpNWu0O+FHpT41ws3bE1Kit6RgsUNAsbVI1FzWGylRnKrsogqPXsdfiJdDQka8qgh+Fpyxhtg==" },
        { "seed": 990123457, "blob": "ug7oV/9F3WjSYY+SkOSlSSUd2Xo3SlQSNZXuWn9+/mSIv9P8n5sr3pqp72SPBMi5GnmvjA9LdPMVdY46Joubm1xAgE3pUmK+kqXP1VAknE69jrYTeZIsBzWIgJSnA4pmA2mDboBjKxDTTyHgRMaOadkObo8WOApmW75nJMid28giyXfSdoJFiXL2WwR3eiuYqN4RvLnS7M31S0HU57pw+AQpVXxYbORQUVZ59kHKXnjLrmcM1v/DLcvmabSEXVtG7pt5gxidwg==" },
        { "seed": 305419896, "blob": "A1UZqFb+HL97yH69CY+EvrzmSCVekVUkXD5/NYbVHzNx5GLD9uDoifNC3ouWrymOA8K+UyaQ9Qc8Hp8VH+c6TOWb8TVA6SPpOwq++8nPvT8k9CfMkMktMNwjEXveqOuxerIyUWmYasc6JBCPXW3vXsC1f9A/Y4sRclV2C/F2ep+bkoYt3zmEXttdqivuEApvMSWA49AJ7fqc4NC7HhGRr/1y5EMxFyUHOL1IGFhhv0/SFXbT/yRC2uKNeJu9NvqRV0AI/LEmgw==" }
      ],
      "task:3.1": [
        { "seed": 2559271654, "blob": "nS97rgD0ntEVYZx9P3XGgML8KqNoG1fKMtVdcxCPXW3vXsDFIOpvJ98ofE1gFetwPdic1dAa8TecZsUTvnr2GX0QZCXfqYxO7eHStdm7QlqYtOt/2AQtWDZAJL1IXQY2o0HKQTOf9ThG9v/DLcvmabSNTUVa7Yl5gzg=" },
        { "seed": 761306381, "blob": "diq0E+vZyXQOhWNRBMjRxek5pT4DNqAuyTACHstSauhE2484iwc/wkQNQyAb6Hw11p2TyHv3RpInwxq+ZacBHBYVK5i0hFvr9oStmOIGVZ+z8WTiMylaPU0l+1ATADGzCMQFPJjyIl3d08Au1rZxrN9IQljxgD7cOJ0=" },
        { "seed": 1596922632, "blob": "c+UJ+MaObG/reU5tud+U7iy2OFUuwUXXLG9vxRZl70PBlHKTZlDbWWEyLlvmfznek5KOY5ZA4ymCHLdluFAEdxNalvOZU/7wk/uAo18RkLT2fvkJHl4/Rij6FgtON7QYjQt4l/UlR8b47C3VqyG0xxpHX/OcN5tnncI=" }
      ],
      "task:3.2": [
        { "seed": 2053145287, "blob": "vFji1ZErd4oUVXXRrpq/K6MrU3jZJL4xcwK0GCHgRMaOadl+MbVDfFtfVaZxOtKbnI8ljiHlWIxdsWy4T1Vvclzn/d5O9uWV7Na7HkjUu/F54xIkaTtEI/cXTVZ5sh+dQnbT+iJA3OPHAdaoPOTfAhVY5Ih5gzg=" },
        { "seed": 2900353402, "blob": "AbPPgjQwknU5YcjF67F6pD5Afo8831ttHtlpL6RLwYlzwjQp1C5nQzckqDE00ZeUgSTIOYRe/VPwarFPSj5qPeGM0Anr7YDqwe0GCY3//n7kCD9TDEAh/BpMEGH8GZpSP92+LUfb+dwq+qs/+Y8aDQjziT/cOJ0=" },
        { "seed": 1015939729, "blob": "6p6YJy/VbVgC3d+BwHT1OVVtiWrHOgQBxQReqg/OjnTYL2PMTwtXLk/ZP3TflJiJKsl/nD/7Iv4rt0ZKITslgIqhB6zwiP/H+lARzKa6ceMPJUg2dyX+EUERJ+RXnFUvlLBpSNz+xjHRhzz6kkoVEKOePppnncI=" }
      ],
      "task:4.1": [
        { "seed": 617863868, "blob": "x8k9PMoqQGO/y5qrBftoUniabJEiZWndGDPbAYqBc981eIZXajQ1VbFOep+am4Uix37aJ5okiTn4E3thEzaW4aEH1afcv/+1fwDa7cU70VdgCwMJG6heGSlvnV3EFgfdx3oChM2DGYvoYsvRYwQGsLF3pXHMjk9lT1VKvNVroSYQWpP5a//O6zlfbSz0ZZeN10myV93z6VqYsVuBc1O2A4GnNcL83d/VX6P6DiVbMfAAqGOpe81+ugmP/f7ktGd9J58iJi0jeSyIgCtxQ6cm1ZGXhZTsK6+Fr/Fq2TWLgUIw//MZSxvuDRn/TUiUg/ctN+1S8T0Tyfm41rshU/ZWpOHHFWecej91v8CaqAX7ERUgzkPJW2oe3Gkv3RuE0kfscCmNEDwDcVu+SAuR2pKSMcl4yieaBPBvvU1PPiBV37CfQ+vx0rXW61FW2v/7cuYNPxlkfju9CgtOdupPkQVgwbBpTdr8wDCb/nHkmFwVV62XeYZn2ok+a21BXL+kZZl+UAS89wrtkLwAUUsxo3Wyg7ZMskf5/YhamKFlwkQI6BPmqRyQtM3/pHnu" },
        { "seed": 3769890539, "blob": "kGwm2TUHe96oj7FuimYDf49/l3R9CLIBL7ZwhMV82DJinR1yVVlBqCYLkdqVhi7PcNthgkWJUuQPFhBkXIv9zHaizsKjksQIaMXxqEqmOngXbnhsxEUFRB7qNtALaqywEB6ZofJu4vV/p6AUbBit3QbSHtOTIxQ4OFKhuRrWSglH/4gclNX1VS4aRuB7+/ygIK5JsoKeMoWvNPAEPKgd7tZCruPDsKQoyOIRSipGmhm3DNgMpGWlZv6KlvCrCAxQ8D45Q1IOQpWfRQA0zDjN/+by/vMzwfTYmHLBW/r2KinnnWg8dPoVd446JoibnlxAgE/pVGK+kqbP0lAknEm9iLZiDoRjVgTIqIOxbIpmejrXKrgsBALFAV6qdpnLL+xwUNxZZTIuIrc/Y+DUrN5tmUaSXpVT51T4eBBhfVqWissHu8ito4D6QV+arrot0TxgGTtdMPoRXVZ5vU+OTjSY7yN80PHMKtygcayJSkJPrc44mymMzDBzTxhE9ap9zD0eEuzvAOPAugsfWW/6bejT6R+8GKykkBGWuTGBCh64C++nTJa/g+2LJqn0Tx0TSLwA4Bz9AsVqpXbahPf8qxgyE8dhZ1I1AGvB11QgRep3" },
        { "seed": 1994858318, "blob": "NXfDJhg8xsntrGj7fHwg2W2RYS1Gyw5YsAGYujaTOmKAHCMHIEPfKnqIpdvII8B03W7FG/Azj3gWYXhalorNB77I3NSQtRRu2oarO7o8YGBqCXDCXnJBb/YwxHxi3awWAu6pg3Lk6Aim0QlqBtrdd88YzOQgZSU+Sta7a8tMEDD6+QGSzoJRXwdA9Az8jb0msj6584M0mNg2gRo6tmrtp1yo/LSw1TbO+mZLW1icAMAKqRKiftJhj5SQ5NwMfU72Ik5HIxBEiOhPcSrKJrr8l+347ETDhceearZai+ksMJCdGSNy7mJw/yUglOyfLV+GUp5WE6GUuLjRITuaVsqMx3oInBRTddCumsZq+358IKAtyTQCHrIAL7JwhLwvnWhWwi5mQzYkqEhhkcyqxhqUN4pYjCTiJeF+ChZ5K4+M0HC8ucXSjsIXH8OAtEy+TXlmcn51s0d0WBjwQd16dqqrZxvovPR6lfEOy9EaVE/tgCjcf7viPmtxGxbo6zPYK0dJqLxeppGxNhZXfrAyroO2D+wQ5fOQCtHvat4KXcFK/vNMz+fDoIAmqeYRWhQFrUPpHL8CjTftdt6Ktur/GGtEhyxsUjUTNYbQGTF35Sjb7sm7weJi3tLWu2TXUYv4CD7xnRkyTK1VK6E0R5rFz2VOpiO4HQ==" },
        { "seed": 1799528021, "blob": "LpI8CyOB0YzGYft9fCDZbZFhLUbLDliyAZm6NpM6YoAcIwcgQ98keoul28gjwHTdbsUb8DOPeBZheFqWis0Hvsjc1JC1FG7ahqs7ujxgYGoJcMJeckFv9jDEfGzdrBYC7qeDcuToCK7RCGoG2tx3zxjM5CNlJT5K1rpry0wQMP35AZLOglJfB0D0DP2NvSayPrjzgzSY2DaBGjq2au2nXKj8tLDVNs76ZktbWJwAwAqpEqJ+0mKPlJDk3A19TvYiTkgjEESI6EZxK8omuv2X7fjsRMCFx55qtluL6SwwkJoZI3LuYnP/JSCU7JItX4ZSnlATppS4uNchPJpWyo7HegicFFF10K6axmz7fnwgoCvJNAIesgwvsnCEvCqdaVbCLmFDNySoSGSRzarGGp83i1iMJOYl4X4KFn0rj4zQcLi5xdKOwhwfw4C0TLpNemZyfnGzRHRYGPRB3np2qq9nGOi89HaV8g66pg0bHNzAAMhp1uI+EixPUNDVa9hyWQeiphL1uYRIUVNlqDKp1a5B5UfmttwAx+tUyEkE8lS4qVSBoprn1Sbws1EUBEj7d+Ac/QLFZ6V22oT3+asYMhPHYWdSNQBrwddUIDTsKJnugeiJ4mbQk8fvZI4Hy7UDPvGMR3VL4ERoqDQFmo2dLU6iXP9UE7Cq+4+Jfyr9WOPZj2wo7TIf" },
        { "seed": 2956188592, "blob": "y20RMJ6WlKcD5noNO6Yyx3MrU5tAIbx2ncsq7HApiBw+BnERpikNhNTBt22OedJqwxS3bfYZfRZ4K4qM0HC/ucDSjsIWH8aAtEy5TXxmcn50s0J0WBj+Qdh6dqqlZx7ovPRylfUOuqYJGxvcwADMadHiPhInT1fQpBzOPQ024o4F49OESCgAMekK5vq0V684rISLRYXeKvYYS6hs8NBf2eKyrqI2v+RgVCxZ7R7GEt4U02DUePiT4fraFgpKhzxIXFQbNZbuWgYouzm84ODvifNC3vLG73WwRPzpXS+Wgm4kA/FkaIgjUYvqhlpa902YTGSl5ae+ylYx60nMkLB+eYQSTgLV34LAdIx4DTimMr4zcwa0GFiyAZy6NuppJ9oofDQ0VbBOeubP294cgECOKZUi/lLlDxMQZFyI/cl2os7Do5fECGjC8a1Kpjp5F2t4bMREBUEe6jbfC2+ssBAWmaXybuL0f6CgFGwbrdoG0h7SkyQUODhVob4a1koIR/iIHJTX9VIuGkbue/z8oCCpSbaCnjKMrzDwdUu4UrnnAoby1dmkKLGzRQgSCbUOoUWnRpY84CfL9Kip5FI0GIk0YQJ6RzWG0BMxdOQo25fA/N3iJcWF1rpk11iL+BJzp8FHMhXgSyG3NACUzIh5TuFG6UJGsPOmz8RuZ6sV457RbCfVK0AkyIiU5Xrtcw0ugjzfNHMQiltv6V+K3TjDOW/MCA0Sfw==" },
        { "seed": 1288256335, "blob": "NEAqjYnTv2KMcg07pjLHcytTm0AhvHacyyrscCmIHD4GcRGmKQ2K1MG3bY550mrDFLdt9hl9FngriozQcL+5wNKOwhYfxoC0TLlNfGZyfnazQnRYGPFB2Hp2qqxnH+i89HOV9Q66pgobG9zAAM1p0eI+EiBPV9CkHM09DTbijgDj0IRIKAcx6grm+r5XrDishIFFht4q9hxLqGzw0FvZ4rKuojO/5GBULFrtH8YS3hHTYdR4+JTh+9oWCk+HPUhcVBY1l+5aBi27Obzg4O6J9ELe8sXvcrBE/OhdKJaCbiMD9mRoiCJRjOqGWln3SphMZKTloL7KVjjrT8yQsH95hRJOAtbfg8B0jHkNOaYyvjRzB7QYWLMBnbo26mon2yh8NDJVsk565snb3ByAQIwpliL+UucPEBBkXI79ynaizsWjlMQIaMDxrkrXTW5YO0ks7FATLx7qT41fKpT/PwyP640k0Ko65ZVqUkvihD6aZ9rLYDxxT0Tu7SuWYh5Rla4St8DjUV8UZPpt+o2uGPEJ762QU5bxY8kKGrZK/vNMz+bDoIAmqecRWhQFrUPpHL8CjTftdt6Ktur/GGtLhyxsUjURNYbQGTF35Sjb7sm7weJir9SJ" },
        { "seed": 452948066, "blob": "GXuXmsz4eu0RGCDNQ8kiLEaIRnekF/PTNoEBJ8wTOQFrCuwxbObP298cgDncac8cuWywARwWEzeW4aEH1aTcv/+1fwHa7cU70VJgCwMJG6leGSlvnVrEFwfdx3MChc2DGYnoYsvRYwYGsLF3pXfMjk9lT1BKvNVroSUQWpP5a/jO6DlfbSX0ZpeN10uyV93z6ViYsVuBc1W2A4GnNcb83d/VX6f6DyVbMfQAqWOpe8h+uwmP/fXktWd9J5siJi0jeSiIgCtxQ6Um0pGXhZbsLK+Fr/dq3jWLgUQw+PMZSxfuChn/TU2Ug/ctN+pS8T0Tyfu417shU/RWpeHHFWGcez91v8aaqQX7ERcgz0PJW2ce3Wkv3R2E0kedBzrCQA1DWUuoJguRo8TGdPE35TGMSo8ljxYKeBUr4efQHtO5q7eOrHlu2v/7cuYNPxlkfh2zUEwMM6MOnAVgir4tR9v53CrroTL1lV1TCLuYKYsgzJ1xLHgPFa+yHIEzREn04Bztm/teQxo/uzimzv5ZpEfyutZLya99j1BFoAfwqRfX6t6u22f8ulIKVVDjXv5ap13TKassgZz65KVDc0aYIjcTYE521pFMf2rybsOx5qPY" },
        { "seed": 1539355737, "blob": "IsaA3+c99XB6O9cpuCx9QZ1VcfIPkrwpnWxWwlc2BmwQ93t0h6PBxnfxN5xnzBCxYrFHBHcTXIr9zHaizsGjksQIaMTxqEqmOnkXbnhsxEQFRB7qNtgLa6ywEB+ZofJu4vZ/p6AUbBmt3QbSHtWTIxQ4OFChuRrWSgxH/IgclNP1Vi4aRup7+PygIK1JsoKeMoKvNPAEPKod79ZCruHDsaQoyOQRSypGmh+3DdgMpGalZ/6Klv6rCQxQ8D45RFIOQpWfQgA0zDjN+Oby/vMzxvTYmHLBXPr2Kiznm2g8dPMVcY46Joqbn1xAgE3pVWK+kqDP01AknE+9ibZiDoBjVATIqIexbopmej7XKLgsBAHFAl6qdpzLLOxwUNtZZjJfVaZwM9GUhMh790aSJ8UHomy3VwR3MyXcuJJC/f2i6sP6TFaS/6Jj+BQpF3xGJfMeWlZ5nRbKX3jLqGcMzLKVcpXmMPmRV0UIu84pmyHCwj4yNhtEt71r2GgeUfz5EqyNtQsBFCf6Ja/FrgayHqKnkFOCryTUCl2uHf7oAZm/naDDJuGzWVoKN7xR" },
        { "seed": 1237619172, "blob": "n9HF9CKyaBtXyi7JNgIey0d351/cxSDqaSffKHxNZBDqeiXV2s2xeYAu4ymCHb5mt0hDKWo94YrMB77I3NSTtRRu2oaqO7o8YGBtCXDCXnJAb/YwxHxv3awWAu6mg3Lk6Aih0QhqBtrUd84YzOQrZSQ+Sta4a8tMEDD/+QGSzoJWXwdA9Az5jb0msj6084M0mNgxgRk6tmrkp1+o/LS71TXO+mZIW1icAMAPqRKiftJmj5SQ5NwJfU72Ik5EIxBEiOhDcSrKJrr0l+z47ETLhcaearZYi+ksMJCfGSNy7mJ2/yUglOyZLV+GUp5UE6GUuLjTITuaVsqKx30InBRbddeumsZo+358IKAvyTQCHrIGL7JwhLwpnWhWwi5kQzYkqEhjkcyqxhqaN4pYjCTlJeB+ChZxK46M0HC+ucXSjsIVH8OAtEy4TXlmcn5zs0d0WBjyQd16dqqpZxvovPR0lfEOuqYPGx/cwADHadXiT2U2AAPh5DTYK2c24vdVt5K8BwcUJ6N1rMjiEu0N0rrTCtzmYo8SE+hEuadMlrWD7oomqY1GWg9I+xq3HPwCxWOldsDJoaf1GGte2WtxUnIOYobLVGcvuyiY7oHsieJ8ncWbsWTXStW/FT62gk4yV+ADfP80BJqNmS1OuBGpD02w87aRg2kquifswQ==" },
        { "seed": 2362389491, "blob": "iJTuMa0vAzagL9UsaG/FFnDyTNqTOIsHPsJFDUMgH+19P86Q1dAalTeIWIxdsGW7QE0oLCWAiqcboqWto/moCAOr8cMlplERFwUWbK8vBS936l21CwHGsHtzmcuXbomZf83EFAd3rbdr0nS9k0l4OFI7odN11iBhR5XmHP6/9T9HGiyFe5GUoErDSdvonljpr12VBFbHHYeyQsSNw9nJKKGLESNGRvNxt2W3DM0PpQ+Qiv+Vq2FlUJlTOSs6Div5ny1lNKVXzZeC8pedM6mZ2PAbwTOW9kJB5/UHPByfFR/gOk7lm/E1QOgj6TsKvvrJz707JPQnvefSYmbtYzlpyMfrsQPmZhVR10XXLGtvxW8wqhn1y0GFcD+zWQtaLk3ZPw2L1MO3bfcskjH9U4k5+BZ7YRM2luShB9Wn3Lr/tX8A2ujFO9FVYA4DCRuqXhwpb51bxBIH3cd8AoDNgxmB6GbL0WMHBrexd6V0zIlPZU9RSrvVa6EiEF2T+Wv7zu85X20o9GGXjddNslPd8+lemLVbgXNftgeB1kLXs4rulXex7GYlW0ikVOtb5lTdaPJ2xc+jofRSAxnKbX0VawAj0MEDODS1aYSg162H+kSJi4zhfNtEhaNTJvuCF3NArlY28SxfytLOIxH3BecYHaj+uMGfLzL1VrPfhCI6wm1Ye5aW0r8l+zEDdNkk3Sx9S8sOMKoPy4h23i4p1FciCmZb+T8tn4DV0HiAOccnmkv+K7dMSiI6JYDzjk7qt43S3+Q=" }
      ],
      "*": [{ "seed": 16355678, "blob": "JQcz9ghMVnmdXMQWB92+OFrU4ttgg59jus1lGwjnhTWXNoidKBIkT1bQpGWYfVMIpbBU7diCOV8Ufr07ptKuQcU4rP3XEcTmZdkKXeETuuIAnKOH0Jxl8L5YHFVQtV7uW/hd" }]
    });

    const ROBOT_CODE_PHRASE_BLOBS = Object.freeze({
      "task:2.1": { "seed": 311769112, "blob": "X+VKr/vvgXVhz0f9n4IZ2hmelg==" },
      "task:2.2": { "seed": 2048129377, "blob": "LTRojp2QJi1kNJJGvGB1L6XDcxrDog==" },
      "task:3.1": { "seed": 985441263, "blob": "v+et1CgGkicjE4xs1WGxeJxq" },
      "task:3.2": { "seed": 3770266941, "blob": "dkgZPrh8xO4aEC/pWfv8n6CasQ==" },
      "task:4.1": { "seed": 1266015570, "blob": "FLga4+r38leYgPzqa16hjRLIJGPujJfI2n4cDoyUjXqmeHScf95dloUpTQ==" }
    });

    function decodeScenarioBlob(entry) {
      if (!entry || typeof entry !== "object") return "";
      const blob = String(entry.blob || "");
      const seed = Number(entry.seed) >>> 0;
      let encoded = "";
      try {
        encoded = atob(blob);
      } catch (_) {
        return "";
      }

      const bytes = new Uint8Array(encoded.length);
      let state = seed;
      for (let i = 0; i < encoded.length; i++) {
        const cipher = encoded.charCodeAt(i) & 0xff;
        bytes[i] = cipher ^ (state & 0xff);
        state = (state * 1664525 + 1013904223) >>> 0;
      }

      try {
        return new TextDecoder("utf-8").decode(bytes);
      } catch (_) {
        let fallback = "";
        for (let i = 0; i < bytes.length; i++) fallback += String.fromCharCode(bytes[i]);
        return fallback;
      }
    }

    function decodeScenarioMap(blobMap) {
      const out = {};
      const source = blobMap && typeof blobMap === "object" ? blobMap : {};
      const keys = Object.keys(source);
      for (const key of keys) {
        const encodedList = Array.isArray(source[key]) ? source[key] : [];
        const decoded = encodedList.map((entry) => decodeScenarioBlob(entry)).filter((text) => text.length > 0);
        if (decoded.length) out[key] = decoded;
      }
      return out;
    }

    function decodeSecretMap(secretMap) {
      const out = {};
      const source = secretMap && typeof secretMap === "object" ? secretMap : {};
      for (const key of Object.keys(source)) {
        const value = decodeScenarioBlob(source[key]);
        if (value) out[key] = value;
      }
      return out;
    }

    function scenarioLabelFromKey(scenarioKey) {
      const key = String(scenarioKey || "");
      if (key.startsWith("example:")) {
        const n = key.slice("example:".length);
        return `–ü—Ä–∏–º–µ—Ä ‚Ññ${n}`;
      }
      if (key.startsWith("task:")) {
        const n = key.slice("task:".length);
        return `–ü–æ–¥–∑–∞–¥–∞—á–∞ ${n}`;
      }
      return "–°—Ü–µ–Ω–∞—Ä–∏–π";
    }

    function visibleScenarioCountForKey(scenarioKey, totalCount) {
      const total = Math.max(0, Math.trunc(Number(totalCount) || 0));
      return total;
    }

    function toKeycapNumberText(value) {
      const safe = Math.max(0, Math.trunc(Number(value) || 0));
      const text = String(safe);
      let out = "";
      for (let i = 0; i < text.length; i++) {
        const code = text.charCodeAt(i) - 48;
        if (code >= 0 && code <= 9) out += KEYCAP_DIGITS[code];
      }
      return out || KEYCAP_DIGITS[0];
    }

    function keyOf(x, y) {
      return `${x}:${y}`;
    }

    function normEmojiToken(value) {
      return String(value || "").replace(/\uFE0F/g, "");
    }

    function toColorCode(value) {
      const token = normEmojiToken(String(value || "").trim().toLowerCase());
      if (!token) return null;
      if (token === "red" || token === "–∫—Ä–∞—Å–Ω—ã–π") return "red";
      if (token === "yellow" || token === "–∂–µ–ª—Ç—ã–π" || token === "–∂—ë–ª—Ç—ã–π") return "yellow";
      if (token === "green" || token === "–∑–µ–ª–µ–Ω—ã–π" || token === "–∑–µ–ª—ë–Ω—ã–π") return "green";
      if (token === "purple" || token === "—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π") return "purple";
      if (token === normEmojiToken("üåπ")) return "red";
      if (token === normEmojiToken("üåª")) return "yellow";
      if (token === normEmojiToken("üçÄ")) return "green";
      if (token === normEmojiToken("üçá")) return "purple";
      return null;
    }

    function buildControlMarks(expectData, width, height) {
      const out = new Map();
      if (!expectData || typeof expectData !== "object") return out;
      const cells = Array.isArray(expectData.cells) ? expectData.cells : [];
      for (const item of cells) {
        if (!item || typeof item !== "object") continue;
        const x = Number(item.x);
        const y = Number(item.y);
        if (!Number.isFinite(x) || !Number.isFinite(y)) continue;
        const nx = Math.trunc(x);
        const ny = Math.trunc(y);
        if (nx < 0 || nx >= width || ny < 0 || ny >= height) continue;
        const colorCode = toColorCode(item.color);
        out.set(keyOf(nx, ny), { colorCode });
      }
      return out;
    }

    function clampCoord(value, maxValue) {
      const num = Number(value);
      if (!Number.isFinite(num)) return 0;
      const n = Math.trunc(num);
      return Math.max(0, Math.min(maxValue, n));
    }

    function setScenarioError(boardEl, metaEl, title, message) {
      if (!boardEl || !metaEl) return;
      metaEl.textContent = String(title || "–°—Ü–µ–Ω–∞—Ä–∏–π");
      boardEl.textContent = "";
      const errorEl = document.createElement("div");
      errorEl.className = "scenario-error";
      errorEl.textContent = String(message || "–°—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
      boardEl.appendChild(errorEl);
    }

    function cloneCells(cells, width, height) {
      const out = [];
      for (let y = 0; y < height; y++) {
        const row = [];
        for (let x = 0; x < width; x++) {
          const cell = cells && cells[y] && cells[y][x] ? cells[y][x] : null;
          row.push({
            color: cell && typeof cell.color === "string" ? cell.color : null,
            temp: cell && Number.isFinite(Number(cell.temp)) ? Math.trunc(Number(cell.temp)) : 0
          });
        }
        out.push(row);
      }
      return out;
    }

    function cloneBoardState(boardState) {
      const controlMarks = new Map();
      if (boardState.controlMarks && typeof boardState.controlMarks.values === "function") {
        for (const [coord, mark] of boardState.controlMarks.entries()) {
          controlMarks.set(String(coord), { colorCode: mark && typeof mark.colorCode === "string" ? mark.colorCode : null });
        }
      }
      return {
        width: boardState.width,
        height: boardState.height,
        start: boardState.start.slice(),
        finish: boardState.finish.slice(),
        robot: boardState.robot.slice(),
        blockedSet: new Set(boardState.blockedSet.values()),
        controlMarks,
        cells: cloneCells(boardState.cells, boardState.width, boardState.height),
        finishReached: Boolean(boardState.finishReached)
      };
    }

    function boardStateFromScenario(scenarioData) {
      const width = scenarioData.width;
      const height = scenarioData.height;
      const blockedSet = new Set();
      for (const item of scenarioData.blocked.values()) blockedSet.add(String(item));
      const start = scenarioData.start.slice();
      const finish = scenarioData.finish.slice();
      const robot = start.slice();
      return {
        width,
        height,
        start,
        finish,
        robot,
        blockedSet,
        controlMarks: buildControlMarks(scenarioData.expect, width, height),
        cells: cloneCells(scenarioData.cells, width, height),
        finishReached: robot[0] === finish[0] && robot[1] === finish[1]
      };
    }

    function applySnapshotToBoardState(boardState, snapshot) {
      const out = cloneBoardState(boardState);
      if (!snapshot || typeof snapshot !== "object") return out;

      if (Array.isArray(snapshot.robot) && snapshot.robot.length === 2) {
        out.robot = [
          clampCoord(snapshot.robot[0], out.width - 1),
          clampCoord(snapshot.robot[1], out.height - 1)
        ];
      }

      if (Array.isArray(snapshot.blocked)) {
        const blockedSet = new Set();
        for (const pair of snapshot.blocked) {
          if (!Array.isArray(pair) || pair.length !== 2) continue;
          const x = Number(pair[0]);
          const y = Number(pair[1]);
          if (!Number.isFinite(x) || !Number.isFinite(y)) continue;
          const nx = Math.trunc(x);
          const ny = Math.trunc(y);
          if (nx < 0 || nx >= out.width || ny < 0 || ny >= out.height) continue;
          blockedSet.add(keyOf(nx, ny));
        }
        out.blockedSet = blockedSet;
      }

      if (Array.isArray(snapshot.cells)) {
        out.cells = cloneCells(snapshot.cells, out.width, out.height);
      }

      out.finishReached = out.robot[0] === out.finish[0] && out.robot[1] === out.finish[1];
      return out;
    }

    function normalizeTrace(trace, boardState) {
      const start = boardState.start.slice();
      const out = [start];
      if (!Array.isArray(trace)) return out;

      function pushPos(x, y) {
        const last = out[out.length - 1];
        if (last && last[0] === x && last[1] === y) return;
        out.push([x, y]);
      }

      for (const pair of trace) {
        if (!Array.isArray(pair) || pair.length !== 2) continue;
        const x = Number(pair[0]);
        const y = Number(pair[1]);
        if (!Number.isFinite(x) || !Number.isFinite(y)) continue;
        const nx = Math.trunc(x);
        const ny = Math.trunc(y);
        if (nx < 0 || nx >= boardState.width || ny < 0 || ny >= boardState.height) continue;
        pushPos(nx, ny);
      }

      return out;
    }

    function renderScenarioBoard(boardEl, metaEl, boardTitle, boardState, phaseText, showControlMarks = true) {
      if (!boardEl || !metaEl) return;
      boardEl.textContent = "";

      const width = boardState.width;
      const height = boardState.height;
      const start = boardState.start;
      const finish = boardState.finish;
      const robot = boardState.robot;
      const blockedSet = boardState.blockedSet;
      const controlMarks = showControlMarks && boardState.controlMarks && typeof boardState.controlMarks.get === "function"
        ? boardState.controlMarks
        : new Map();
      const cells = boardState.cells;
      const metaParts = [];
      if (boardTitle) metaParts.push(String(boardTitle));
      metaParts.push(`${width}x${height}`);
      if (phaseText) metaParts.push(String(phaseText));
      metaEl.textContent = metaParts.join(" ¬∑ ");

      const gridEl = document.createElement("div");
      gridEl.className = "scenario-grid";
      gridEl.style.gridTemplateColumns = `repeat(${width + 1}, 38px)`;

      const cornerEl = document.createElement("div");
      cornerEl.className = "scenario-axis corner";
      cornerEl.textContent = "x‚Üí\ny‚Üì";
      cornerEl.title = "x: —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ, y: —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑";
      gridEl.appendChild(cornerEl);
      for (let x = 0; x < width; x++) {
        const xEl = document.createElement("div");
        xEl.className = "scenario-axis";
        xEl.textContent = toKeycapNumberText(x);
        gridEl.appendChild(xEl);
      }

      for (let y = 0; y < height; y++) {
        const yEl = document.createElement("div");
        yEl.className = "scenario-axis";
        yEl.textContent = toKeycapNumberText(y);
        gridEl.appendChild(yEl);
        for (let x = 0; x < width; x++) {
          const cellEl = document.createElement("div");
          cellEl.className = "scenario-cell";
          const blocked = blockedSet.has(keyOf(x, y));
          if (blocked) {
            cellEl.classList.add("blocked");
            cellEl.textContent = "‚ñ†";
          } else {
            const cell = cells[y][x];
            if (cell && cell.color && COLOR_CSS_BY_CODE[cell.color]) {
              cellEl.classList.add(COLOR_CSS_BY_CODE[cell.color]);
            }
            const temp = cell && Number.isFinite(Number(cell.temp)) ? Math.trunc(Number(cell.temp)) : 0;
            if (temp !== 0) {
              const tempEl = document.createElement("span");
              tempEl.className = "scenario-temp";
              tempEl.textContent = String(temp);
              cellEl.appendChild(tempEl);
            }

            const controlMark = controlMarks.get(keyOf(x, y));
            if (controlMark) {
              const controlEl = document.createElement("span");
              controlEl.className = "scenario-control";
              if (controlMark.colorCode && COLOR_CSS_BY_CODE[controlMark.colorCode]) {
                controlEl.classList.add(COLOR_CSS_BY_CODE[controlMark.colorCode]);
              }
              controlEl.textContent = "‚óè";
              cellEl.appendChild(controlEl);
            }
          }

          if (x === start[0] && y === start[1]) {
            const startEl = document.createElement("span");
            startEl.className = "scenario-marker start";
            startEl.textContent = "S";
            cellEl.appendChild(startEl);
          }

          if (x === finish[0] && y === finish[1]) {
            cellEl.classList.add("finish");
            const finishEl = document.createElement("span");
            finishEl.className = "scenario-marker finish";
            finishEl.textContent = "F";
            cellEl.appendChild(finishEl);
          }

          if (x === robot[0] && y === robot[1]) {
            const robotEl = document.createElement("span");
            robotEl.className = "scenario-marker";
            robotEl.textContent = "ü§ñ";
            cellEl.appendChild(robotEl);
          }

          gridEl.appendChild(cellEl);
        }
      }

      boardEl.appendChild(gridEl);
    }

    if (window.LovelaceLabShell && window.LovelaceDomains && typeof window.LovelaceDomains.createRobotDomain === "function") {
      const robotDomain = window.LovelaceDomains.createRobotDomain();
      const fixedTestsByScenario = decodeScenarioMap(ROBOT_SCENARIO_BLOBS);
      const codePhraseByScenario = decodeSecretMap(ROBOT_CODE_PHRASE_BLOBS);
      const scenarioMetaEl = document.getElementById("scenarioMeta");
      const scenarioBoardEl = document.getElementById("scenarioBoard");
      const scenarioAnimationToggleEl = document.getElementById("scenarioAnimationToggle");
      const codePhrasePanelEl = document.getElementById("codePhrasePanel");
      const codePhraseInputEl = document.getElementById("codePhraseInput");
      const copyCodePhraseBtn = document.getElementById("copyCodePhraseBtn");
      const ANIMATION_STEP_MS = 120;

      let lastScenarioPayload = null;
      let lastScenarioDomainResults = null;
      let animationTimerIds = [];
      let animationToken = 0;
      let task1ControlMarksRevealed = false;

      function isTaskOneScenarioKey(scenarioKey) {
        return /^task:1\./.test(String(scenarioKey || ""));
      }

      function scheduleScenarioFrame(callback, delayMs) {
        const timerId = window.setTimeout(() => {
          animationTimerIds = animationTimerIds.filter((id) => id !== timerId);
          callback();
        }, delayMs);
        animationTimerIds.push(timerId);
      }

      function stopScenarioAnimation() {
        if (animationTimerIds.length) {
          for (const timerId of animationTimerIds) {
            window.clearTimeout(timerId);
          }
          animationTimerIds = [];
        }
        animationToken += 1;
      }

      function isAnimationEnabled() {
        if (!scenarioAnimationToggleEl) return true;
        return scenarioAnimationToggleEl.checked;
      }

      function hideRobotCodePhrase() {
        if (!codePhrasePanelEl) return;
        codePhrasePanelEl.hidden = true;
        if (codePhraseInputEl) codePhraseInputEl.value = "";
      }

      function showRobotCodePhrase(phrase) {
        if (!codePhrasePanelEl || !codePhraseInputEl) return;
        const text = String(phrase || "");
        if (!text) {
          hideRobotCodePhrase();
          return;
        }
        codePhraseInputEl.value = text;
        codePhrasePanelEl.hidden = false;
      }

      function isSuccessfulScenarioRun(payload) {
        const results = payload && Array.isArray(payload.outputResults) ? payload.outputResults : [];
        if (!results.length) return false;
        for (const item of results) {
          if (!item || item.kind !== "ok") return false;
        }
        return true;
      }

      function drawScenarioView(payload, domainResults) {
        lastScenarioPayload = payload || null;
        lastScenarioDomainResults = Array.isArray(domainResults) ? domainResults.slice() : null;
        const scenarioKey = payload && typeof payload.scenarioKey === "string" ? payload.scenarioKey : "";
        const showControlMarks = !isTaskOneScenarioKey(scenarioKey) || task1ControlMarksRevealed;
        const tests = payload && Array.isArray(payload.tests) ? payload.tests : [];
        const scenarioTitle = scenarioLabelFromKey(scenarioKey);
        stopScenarioAnimation();
        scenarioBoardEl.textContent = "";

        if (!tests.length) {
          setScenarioError(scenarioBoardEl, scenarioMetaEl, `${scenarioTitle}: –æ—à–∏–±–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.`, "–°—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ –∑–∞–¥–∞–Ω.");
          return;
        }
        if (typeof robotDomain.parseScenario !== "function") {
          setScenarioError(scenarioBoardEl, scenarioMetaEl, `${scenarioTitle}: –æ—à–∏–±–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.`, "–ü–∞—Ä—Å–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
          return;
        }

        const totalCount = tests.length;
        const visibleCount = visibleScenarioCountForKey(scenarioKey, totalCount);
        const shownCount = Math.max(0, Math.min(totalCount, visibleCount));
        if (shownCount < 1) {
          setScenarioError(scenarioBoardEl, scenarioMetaEl, `${scenarioTitle}: –æ—à–∏–±–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.`, "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª–µ–π.");
          return;
        }

        scenarioMetaEl.textContent = shownCount < totalCount
          ? `${scenarioTitle}: ${shownCount}/${totalCount}`
          : `${scenarioTitle}: ${shownCount}`;
        const token = animationToken;

        for (let i = 0; i < shownCount; i++) {
          const cardEl = document.createElement("section");
          cardEl.className = "scenario-card";
          const cardMetaEl = document.createElement("div");
          cardMetaEl.className = "scenario-card-meta";
          const cardBoardEl = document.createElement("div");
          cardBoardEl.className = "scenario-card-board";
          cardEl.appendChild(cardMetaEl);
          cardEl.appendChild(cardBoardEl);
          scenarioBoardEl.appendChild(cardEl);

          const boardTitle = `${i + 1}/${shownCount}`;
          const scenarioText = String(tests[i] || "");
          if (!scenarioText) {
            setScenarioError(cardBoardEl, cardMetaEl, `${boardTitle}: –æ—à–∏–±–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.`, "–°—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ –∑–∞–¥–∞–Ω.");
            continue;
          }

          const parsed = robotDomain.parseScenario(scenarioText);
          if (!parsed || !parsed.ok) {
            setScenarioError(cardBoardEl, cardMetaEl, `${boardTitle}: –æ—à–∏–±–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.`, (parsed && parsed.error) || "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.");
            continue;
          }

          const initialState = boardStateFromScenario(parsed.scenario);
          const result = Array.isArray(domainResults) ? domainResults[i] : null;
          const snapshot = result && result.snapshot ? result.snapshot : null;
          const trace = result && Array.isArray(result.trace) ? result.trace : null;

          if (!snapshot) {
            renderScenarioBoard(cardBoardEl, cardMetaEl, boardTitle, initialState, "—Å—Ç–∞—Ä—Ç", showControlMarks);
            continue;
          }

          const finalState = applySnapshotToBoardState(initialState, snapshot);
          const finalPhase = finalState.finishReached ? "—Ñ–∏–Ω–∏—à" : "–Ω–µ —Ñ–∏–Ω–∏—à";
          const tracePositions = normalizeTrace(trace, initialState);

          if (!isAnimationEnabled() || tracePositions.length < 2) {
            renderScenarioBoard(cardBoardEl, cardMetaEl, boardTitle, finalState, finalPhase, showControlMarks);
            continue;
          }

          let frameIndex = 0;
          const lastIndex = tracePositions.length - 1;
          const renderNextFrame = () => {
            if (token !== animationToken) return;
            const frameState = cloneBoardState(initialState);
            frameState.robot = tracePositions[frameIndex].slice();
            frameState.finishReached = frameState.robot[0] === frameState.finish[0] && frameState.robot[1] === frameState.finish[1];
            const phase = `${frameIndex}/${lastIndex}`;
            renderScenarioBoard(cardBoardEl, cardMetaEl, boardTitle, frameState, phase, showControlMarks);

            if (frameIndex < lastIndex) {
              frameIndex += 1;
              scheduleScenarioFrame(renderNextFrame, ANIMATION_STEP_MS);
              return;
            }

            scheduleScenarioFrame(() => {
              if (token !== animationToken) return;
              renderScenarioBoard(cardBoardEl, cardMetaEl, boardTitle, finalState, finalPhase, showControlMarks);
            }, ANIMATION_STEP_MS);
          };

          renderNextFrame();
        }
      }

      if (scenarioAnimationToggleEl) {
        try {
          if (window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
            scenarioAnimationToggleEl.checked = false;
          }
        } catch (_) {}
        scenarioAnimationToggleEl.addEventListener("change", () => {
          if (lastScenarioPayload) {
            drawScenarioView(lastScenarioPayload, lastScenarioDomainResults);
          }
        });
      }

      if (copyCodePhraseBtn) {
        copyCodePhraseBtn.addEventListener("click", async () => {
          const text = codePhraseInputEl ? String(codePhraseInputEl.value || "") : "";
          if (!text) return;
          try {
            if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
              await navigator.clipboard.writeText(text);
              return;
            }
          } catch (_) {}
          try {
            if (codePhraseInputEl) {
              codePhraseInputEl.focus();
              codePhraseInputEl.select();
              document.execCommand("copy");
            }
          } catch (_) {}
        });
      }

      window.LovelaceLabShell.boot({
        domain: robotDomain,
        examples: ROBOT_EXAMPLES,
        taskSubtaskCounts: { "2": 2, "3": 2, "4": 1 },
        subtaskPresets: ROBOT_SUBTASK_PRESETS,
        subtaskTexts: ROBOT_SUBTASK_TEXTS,
        keyboardGroups: ROBOT_KEYBOARD_GROUPS,
        lineDigits: KEYCAP_DIGITS,
        maxTracePoints: 2200,
        fixedTestsByScenario,
        onScenarioChange(payload) {
          const scenarioKey = payload && typeof payload.scenarioKey === "string" ? payload.scenarioKey : "";
          if (isTaskOneScenarioKey(scenarioKey)) task1ControlMarksRevealed = false;
          hideRobotCodePhrase();
          drawScenarioView(payload, null);
        },
        onRunComplete(payload) {
          const scenarioKey = payload && typeof payload.scenarioKey === "string" ? payload.scenarioKey : "";
          if (isTaskOneScenarioKey(scenarioKey)) task1ControlMarksRevealed = true;
          const domainResults = payload && Array.isArray(payload.domainResults) ? payload.domainResults : null;
          drawScenarioView(payload, domainResults);
          const phrase = codePhraseByScenario[scenarioKey];
          if (phrase && isSuccessfulScenarioRun(payload)) showRobotCodePhrase(phrase);
          else hideRobotCodePhrase();
        }
      });
    }
  </script>
</body>
</html>
