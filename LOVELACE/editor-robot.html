<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22%3E%F0%9F%A7%91%E2%80%8D%F0%9F%94%AC%3C/text%3E%3C/svg%3E">
  <title>–≠–º–æ–¥–∑–∏-—Ä–æ–±–æ—Ç</title>
  <script src="../section-auth.js"></script>
  <script>window.SectionAuth && window.SectionAuth.guardPage("LOVELACE", { requiredProfile: "ROBOT" });</script>
  <style>
    @font-face {
      font-family: "Noto Color Emoji";
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src:
        url("https://cdn.jsdelivr.net/fontsource/fonts/noto-color-emoji@latest/emoji-400-normal.woff2") format("woff2"),
        url("https://cdn.jsdelivr.net/fontsource/fonts/noto-color-emoji@latest/emoji-400-normal.ttf") format("truetype");
    }

    :root {
      --bg: #f3f4f6;
      --panel: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #d1d5db;
      --accent: #2563eb;
      --accent-strong: #1d4ed8;
      --danger-bg: #fee2e2;
      --danger-fg: #991b1b;
      --ok-bg: #dcfce7;
      --ok-fg: #166534;
      --warn-bg: #fef3c7;
      --warn-fg: #92400e;
      --emoji-font: "Noto Color Emoji", "Twemoji Mozilla", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Sans", "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 0%, #ffffff, var(--bg));
      color: var(--text);
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      padding: 20px;
    }

    .app {
      width: min(1320px, 100%);
      margin: 0 auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 14px 30px rgba(17, 24, 39, 0.09);
      display: grid;
      gap: 12px;
    }

    .topbar {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .title {
      margin: 0;
      font-size: clamp(1.35rem, 2vw, 1.8rem);
      font-weight: 900;
      letter-spacing: -0.02em;
    }

    .back-link {
      text-decoration: none;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      background: #fff;
      padding: 8px 12px;
      font-weight: 700;
      transition: 120ms ease;
    }

    .back-link:hover {
      border-color: #9ca3af;
      transform: translateY(-1px);
    }

    .blocks {
      display: grid;
      gap: 12px;
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fcfcfd;
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .panel[hidden] {
      display: none !important;
    }

    h2 {
      margin: 0;
      font-size: 1rem;
      font-weight: 800;
    }

    .block-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .block-num {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      display: inline-grid;
      place-items: center;
      font-size: 12px;
      font-weight: 900;
      background: #dbeafe;
      color: #1d4ed8;
      border: 1px solid #93c5fd;
      flex: 0 0 auto;
    }

    .switchers {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr 1fr;
    }

    .mini-title {
      font-size: 12px;
      font-weight: 800;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #475569;
      margin-bottom: 6px;
    }

    label {
      font-weight: 700;
      font-size: 14px;
    }

    textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      outline: none;
      transition: 120ms ease;
      resize: vertical;
    }

    .text-input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      outline: none;
      transition: 120ms ease;
      font: inherit;
    }

    .text-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .emoji-field {
      font-family: var(--emoji-font);
      font-size: 18px;
      line-height: 1.45;
    }

    .code-editor {
      display: grid;
      grid-template-columns: auto 1fr;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }

    .code-editor:focus-within {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .code-lines {
      width: 84px;
      min-width: 84px;
      border: none;
      border-right: 1px solid #e5e7eb;
      border-radius: 0;
      background: #f8fafc;
      color: #64748b;
      text-align: right;
      resize: none;
      overflow: hidden;
      padding: 10px 8px;
      letter-spacing: 0;
      word-spacing: 0;
      font-variant-ligatures: none;
      user-select: none;
      pointer-events: none;
    }

    .code-lines:focus {
      box-shadow: none;
      border-color: #e5e7eb;
    }

    .code-input {
      min-height: 320px;
      border: none;
      border-radius: 0;
      background: transparent;
    }

    .code-input:focus {
      border-color: transparent;
      box-shadow: none;
    }

    .stdin-input {
      min-height: 84px;
      font-family: "Noto Sans", "Segoe UI", "Noto Color Emoji", "Twemoji Mozilla", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      font-size: 18px;
      line-height: 1.35;
      letter-spacing: 0;
      word-spacing: 0;
      font-variant-ligatures: none;
    }

    .output-box {
      min-height: 140px;
      font-family: "Noto Sans", "Segoe UI", "Noto Color Emoji", "Twemoji Mozilla", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      font-size: 18px;
      line-height: 1.35;
      letter-spacing: 0;
      word-spacing: 0;
      font-variant-ligatures: none;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .examples {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .task-grid,
    .subtask-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .subtask-grid {
      margin-top: 8px;
      min-height: 40px;
    }

    .subtask-grid[hidden] {
      display: none !important;
    }

    .task-text-wrap[hidden] {
      display: none !important;
    }

    .task-text-wrap {
      margin-top: 8px;
      display: grid;
      gap: 6px;
    }

    .task-text-label {
      font-size: 14px;
      font-weight: 700;
    }

    .task-text {
      min-height: 72px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      padding: 10px 12px;
      font-size: 16px;
      line-height: 1.35;
      letter-spacing: 0;
      word-spacing: 0;
      font-variant-ligatures: none;
    }

    .task-text p {
      margin: 0;
    }

    .task-text p + p {
      margin-top: 6px;
    }

    .scenario-wrap {
      display: grid;
      gap: 10px;
    }

    .scenario-tools {
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .scenario-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 700;
      color: #1f2937;
      user-select: none;
      cursor: pointer;
    }

    .scenario-toggle input {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
      cursor: pointer;
      margin: 0;
    }

    .scenario-meta {
      font-size: 13px;
      font-weight: 700;
      color: #334155;
      min-height: 18px;
    }

    .scenario-board {
      border: 1px solid #dbeafe;
      border-radius: 10px;
      background: #f8fafc;
      padding: 10px;
      min-height: 150px;
      overflow: auto;
    }

    .scenario-grid {
      display: grid;
      gap: 4px;
      width: max-content;
    }

    .scenario-cell {
      width: 38px;
      height: 38px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background: #ffffff;
      position: relative;
      display: grid;
      place-items: center;
      font-family: var(--emoji-font);
      font-size: 18px;
      line-height: 1;
    }

    .scenario-cell.color-red { background: #fee2e2; }
    .scenario-cell.color-yellow { background: #fef9c3; }
    .scenario-cell.color-green { background: #dcfce7; }
    .scenario-cell.color-purple { background: #f3e8ff; }

    .scenario-cell.blocked {
      background: #e5e7eb;
      border-color: #94a3b8;
      color: #334155;
      font-size: 17px;
    }

    .scenario-cell.finish {
      box-shadow: inset 0 0 0 2px #2563eb;
    }

    .scenario-marker {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      pointer-events: none;
      font-family: var(--emoji-font);
      font-size: 18px;
      line-height: 1;
    }

    .scenario-marker.start {
      font-size: 12px;
      font-weight: 900;
      color: #0f172a;
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      place-items: start;
      padding-top: 2px;
      padding-left: 4px;
      justify-items: start;
      align-items: start;
    }

    .scenario-marker.finish {
      font-size: 12px;
      font-weight: 900;
      color: #1d4ed8;
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      place-items: end;
      padding-bottom: 2px;
      padding-right: 4px;
      justify-items: end;
      align-items: end;
    }

    .scenario-temp {
      position: absolute;
      right: 3px;
      top: 2px;
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      font-size: 10px;
      font-weight: 800;
      color: #475569;
      line-height: 1;
      pointer-events: none;
    }

    .scenario-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 14px;
      align-items: center;
      font-size: 12px;
      font-weight: 700;
      color: #334155;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-chip {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #94a3b8;
      display: inline-grid;
      place-items: center;
      font-size: 12px;
      line-height: 1;
      font-family: var(--emoji-font);
    }

    .legend-chip.red { background: #fee2e2; }
    .legend-chip.yellow { background: #fef9c3; }
    .legend-chip.green { background: #dcfce7; }
    .legend-chip.purple { background: #f3e8ff; }
    .legend-chip.blocked { background: #e5e7eb; }

    .scenario-error {
      color: #991b1b;
      font-weight: 700;
      font-size: 14px;
      padding: 8px;
      border: 1px dashed #fca5a5;
      border-radius: 8px;
      background: #fef2f2;
      width: fit-content;
    }

    .test-label {
      font-size: 13px;
      font-weight: 800;
      color: #334155;
    }

    .test-output-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .test-output-card {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #ffffff;
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .test-output-card.ok {
      border-color: #86efac;
      background: #f0fdf4;
    }

    .test-output-card.error {
      border-color: #fca5a5;
      background: #fef2f2;
    }

    .test-output-card.warn {
      border-color: #fcd34d;
      background: #fffbeb;
    }

    .test-output-meta {
      font-size: 12px;
      font-weight: 700;
      color: #475569;
    }

    button {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      color: var(--text);
      font: inherit;
      font-weight: 700;
      padding: 9px 12px;
      cursor: pointer;
      transition: 120ms ease;
    }

    button:hover {
      border-color: #9ca3af;
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.65;
      cursor: not-allowed;
      transform: none;
    }

    .switchers button[aria-pressed="true"] {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .switchers button[aria-pressed="true"]:hover {
      background: var(--accent-strong);
      border-color: var(--accent-strong);
    }

    button.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    button.primary:hover {
      background: var(--accent-strong);
      border-color: var(--accent-strong);
    }

    .status-box {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-weight: 700;
      background: #f3f4f6;
      color: #1f2937;
      min-height: 44px;
      display: flex;
      align-items: center;
    }

    .status-box.ok {
      background: var(--ok-bg);
      color: var(--ok-fg);
      border-color: #86efac;
    }

    .status-box.error {
      background: var(--danger-bg);
      color: var(--danger-fg);
      border-color: #fca5a5;
    }

    .status-box.warn {
      background: var(--warn-bg);
      color: var(--warn-fg);
      border-color: #fcd34d;
    }

    .step-count {
      font-weight: 700;
      color: #1f2937;
      font-size: 14px;
    }

    .keyboard {
      display: grid;
      gap: 10px;
    }

    .keyboard-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 220px;
      gap: 10px;
      align-items: start;
    }

    .keyboard-left {
      display: grid;
      gap: 10px;
      min-width: 0;
    }

    .emoji-group {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #fff;
      padding: 10px;
    }

    .emoji-group.group-1 { background: linear-gradient(180deg, #ffffff, #f8fafc); }
    .emoji-group.group-2 { background: linear-gradient(180deg, #ffffff, #f9fafb); }
    .emoji-group.group-3 { background: linear-gradient(180deg, #ffffff, #eff6ff); }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
      gap: 6px;
    }

    .emoji-btn {
      font-family: var(--emoji-font);
      font-size: 22px;
      line-height: 1;
      padding: 8px 6px;
      min-height: 40px;
      display: grid;
      place-items: center;
    }

    .editor-nav {
      border: 1px solid #d1d5db;
      border-radius: 10px;
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .nav-title {
      margin: 0;
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      color: #475569;
    }

    .nav-arrows {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      grid-template-areas:
        ". up ."
        "left down right";
      gap: 6px;
    }

    .nav-actions {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
    }

    .nav-btn {
      min-height: 42px;
      padding: 7px 8px;
      display: grid;
      place-items: center;
      font-weight: 800;
      border-radius: 10px;
      user-select: none;
    }

    .nav-btn.up { grid-area: up; }
    .nav-btn.left { grid-area: left; }
    .nav-btn.down { grid-area: down; }
    .nav-btn.right { grid-area: right; }
    .nav-btn.enter { grid-column: 1 / -1; }

    .vars-panel[hidden] {
      display: none !important;
    }

    @media (max-width: 1040px) {
      .switchers {
        grid-template-columns: 1fr;
      }

      .keyboard-layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <header class="topbar">
      <h1 class="title">–≠–º–æ–¥–∑–∏-—Ä–æ–±–æ—Ç</h1>
      <a href="../index.html" class="back-link">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </header>

    <section class="blocks">
      <section class="panel">
        <h2 class="block-title"><span class="block-num">0</span>–ü—Ä–∏–º–µ—Ä—ã –∏ –ó–∞–¥–∞–Ω–∏—è</h2>
        <div class="switchers">
          <section>
            <div class="mini-title">–ü—Ä–∏–º–µ—Ä—ã</div>
            <div class="examples">
              <button id="example1Btn" type="button" aria-pressed="false">–ü—Ä–∏–º–µ—Ä ‚Ññ1</button>
              <button id="example2Btn" type="button" aria-pressed="false">–ü—Ä–∏–º–µ—Ä ‚Ññ2</button>
              <button id="example3Btn" type="button" aria-pressed="false">–ü—Ä–∏–º–µ—Ä ‚Ññ3</button>
              <button id="example4Btn" type="button" aria-pressed="false">–ü—Ä–∏–º–µ—Ä ‚Ññ4</button>
              <button id="example5Btn" type="button" aria-pressed="false">–ü—Ä–∏–º–µ—Ä ‚Ññ5</button>
            </div>
          </section>
          <section>
            <div class="mini-title">–ó–∞–¥–∞–Ω–∏—è</div>
            <div id="taskButtons" class="task-grid">
              <button type="button" data-task="1" aria-pressed="false">–ó–∞–¥–∞–Ω–∏–µ 1</button>
              <button type="button" data-task="2" aria-pressed="false">–ó–∞–¥–∞–Ω–∏–µ 2</button>
              <button type="button" data-task="3" aria-pressed="false">–ó–∞–¥–∞–Ω–∏–µ 3</button>
              <button type="button" data-task="4" aria-pressed="false">–ó–∞–¥–∞–Ω–∏–µ 4</button>
            </div>
            <div id="taskSubtasks" class="subtask-grid" hidden></div>
            <section id="taskTextWrap" class="task-text-wrap" hidden>
              <div class="task-text-label">–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è</div>
              <div id="taskText" class="task-text"></div>
            </section>
          </section>
        </div>
      </section>

      <section class="panel">
        <h2 class="block-title"><span class="block-num">1</span>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞</h2>
        <label for="codeInput">–ö–æ–¥</label>
        <div class="code-editor">
          <textarea id="codeLineNumbers" class="emoji-field code-lines" readonly tabindex="-1" aria-hidden="true">üìå</textarea>
          <textarea id="codeInput" class="emoji-field code-input" spellcheck="false" autocomplete="off" autocapitalize="off"></textarea>
        </div>
      </section>

      <section class="panel">
        <h2 class="block-title"><span class="block-num">2</span>–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞</h2>
        <div id="emojiKeyboard" class="keyboard"></div>
      </section>

      <section class="panel">
        <h2 class="block-title"><span class="block-num">3</span>–ü–æ–ª–µ —Å—Ü–µ–Ω–∞—Ä–∏—è</h2>
        <div class="scenario-wrap">
          <div class="scenario-tools">
            <label class="scenario-toggle" for="scenarioAnimationToggle">
              <input id="scenarioAnimationToggle" type="checkbox" checked>
              –ê–Ω–∏–º–∞—Ü–∏—è —Ä–æ–±–æ—Ç–∞
            </label>
          </div>
          <div id="scenarioMeta" class="scenario-meta"></div>
          <div id="scenarioBoard" class="scenario-board"></div>
          <div class="scenario-legend">
            <span class="legend-item"><span class="legend-chip">ü§ñ</span>–†–æ–±–æ—Ç</span>
            <span class="legend-item"><span class="legend-chip blocked">‚ñ†</span>–°—Ç–µ–Ω–∞</span>
            <span class="legend-item"><span class="legend-chip">S</span>–°—Ç–∞—Ä—Ç</span>
            <span class="legend-item"><span class="legend-chip">F</span>–§–∏–Ω–∏—à</span>
          </div>
        </div>
      </section>

      <section class="panel">
        <h2 class="block-title"><span class="block-num">4</span>–ó–∞–ø—É—Å–∫</h2>
        <div class="controls">
          <button id="runBtn" class="primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
          <button id="resetBtn">–°–±—Ä–æ—Å</button>
        </div>
        <div id="statusBox" class="status-box">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞.</div>
        <div id="stepCount" class="step-count">–°—É–º–º–∞—Ä–Ω—ã–µ —à–∞–≥–∏: 0</div>
      </section>

      <section class="panel" hidden>
        <h2 class="block-title"><span class="block-num">5</span>–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
        <div id="testOutputs" class="test-output-grid"></div>
      </section>

      <section id="codePhrasePanel" class="panel" hidden>
        <h2 class="block-title"><span class="block-num">6</span>–ö–æ–¥–æ–≤–∞—è —Ñ—Ä–∞–∑–∞</h2>
        <label for="codePhraseInput">–ö–æ–¥–æ–≤–∞—è —Ñ—Ä–∞–∑–∞</label>
        <input id="codePhraseInput" class="text-input" type="text" autocomplete="off" autocapitalize="off" spellcheck="false" placeholder="–ö–æ–¥–æ–≤–∞—è —Ñ—Ä–∞–∑–∞" readonly>
        <div class="controls">
          <button id="copyCodePhraseBtn" type="button">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </section>
    </section>

    <section class="vars-panel" hidden>
      <h2>–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö</h2>
      <div id="varsGrid"></div>
    </section>
  </main>

  <script src="./js/lab-shell.js"></script>
  <script src="./js/domain-robot.js"></script>
  <script>
    const KEYCAP_DIGITS = ["0Ô∏è‚É£", "1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£", "9Ô∏è‚É£"];
    const COLOR_CSS_BY_CODE = { red: "color-red", yellow: "color-yellow", green: "color-green", purple: "color-purple" };

    const ROBOT_EXAMPLES = [
      { label: "–ü—Ä–∏–º–µ—Ä ‚Ññ1", code: ["üö∂üö†", "üö∂üö†", "üö∂üöá", "üö∂üöá", "üö∂üöú"].join("\n") },
      { label: "–ü—Ä–∏–º–µ—Ä ‚Ññ2", code: ["üö∂üö†", "üö∂üöá", "üé®üåπ", "üö∂üö†", "üé®üçÄ"].join("\n") },
      { label: "–ü—Ä–∏–º–µ—Ä ‚Ññ3", code: ["ü§îüß±üö†", "üö∂üöá", "üòê", "üö∂üö†", "üé®üåª"].join("\n") },
      { label: "–ü—Ä–∏–º–µ—Ä ‚Ññ4", code: ["üîÇ4Ô∏è‚É£", "üö∂üö†", "üòê", "üö∂üöá", "üé®üçá"].join("\n") },
      { label: "–ü—Ä–∏–º–µ—Ä ‚Ññ5", code: ["üîÅüõ§üö†", "üö∂üö†", "üòê", "üö∂üöá", "üé®üçÄ"].join("\n") }
    ];

    const ROBOT_SUBTASK_PRESETS = Object.freeze({
      "1.1": {
        code: [
          "üö∂üö†",
          "üö∂üö†",
          "üö∂üöá"
        ].join("\n")
      },
      "1.2": {
        code: [
          "üö∂üö†",
          "üö∂üö†",
          "üö∂üö†",
          "üö∂üöá",
          "üé®üçÄ"
        ].join("\n")
      },
      "1.3": {
        code: [
          "ü§îüß±üö†",
          "üö∂üöá",
          "üòê",
          "ü§îüõ§üö†",
          "üö∂üö†",
          "üòê",
          "üé®üåª"
        ].join("\n")
      },
      "1.4": {
        code: [
          "üîÇ4Ô∏è‚É£",
          "üö∂üö†",
          "üòê",
          "üö∂üöá",
          "üé®üçá"
        ].join("\n")
      },
      "2.1": { code: "" },
      "2.2": { code: "" },
      "3.1": {
        code: [
          "üîÇ2Ô∏è‚É£",
          "ü§îüõ§üö†",
          "üö∂üö†",
          "üòê",
          "üòê",
          "ü§îüõ§üöá",
          "üö∂üöá",
          "üòê",
          "ü§îüèÅ",
          "üé®üçá",
          "üòê"
        ].join("\n")
      },
      "3.2": {
        code: [
          "üîÅüõ§üöá",
          "üö∂üöá",
          "üòê",
          "üîÅüõ§üö†",
          "üö∂üö†",
          "üòê",
          "ü§îüèÅ",
          "üé®üåπ",
          "üòê"
        ].join("\n")
      },
      "4.1": { code: "" }
    });

    const ROBOT_SUBTASK_TEXTS = Object.freeze({
      "1.1": ["–î–æ–π—Ç–∏ –¥–æ —Ñ–∏–Ω–∏—à–∞ –Ω–∞ –ø–æ–ª–µ."],
      "1.2": ["–î–æ–π—Ç–∏ –¥–æ —Ñ–∏–Ω–∏—à–∞ –∏ –ø–æ–∫—Ä–∞—Å–∏—Ç—å —Ñ–∏–Ω–∏—à –≤ üçÄ."],
      "1.3": ["–ü—Ä–æ–π—Ç–∏ –ø–æ–ª–µ —Å —Ä–∞–∑–≤–∏–ª–∫–æ–π –∏ –ø–æ–∫—Ä–∞—Å–∏—Ç—å —Ñ–∏–Ω–∏—à –≤ üåª."],
      "1.4": ["–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–∏–∫–ª –ø–æ —Å—á–µ—Ç—á–∏–∫—É, –¥–æ–π—Ç–∏ –¥–æ —Ñ–∏–Ω–∏—à–∞ –∏ –ø–æ–∫—Ä–∞—Å–∏—Ç—å –µ–≥–æ –≤ üçá."],
      "2.1": ["–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è –¥–æ–π—Ç–∏ –¥–æ —Ñ–∏–Ω–∏—à–∞ –∏ –ø–æ–∫—Ä–∞—Å–∏—Ç—å —Ñ–∏–Ω–∏—à –≤ üåπ."],
      "2.2": ["–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è –ø–æ–∫—Ä–∞—Å–∏—Ç—å —Å—Ç–∞—Ä—Ç –≤ üçÄ, –¥–æ–π—Ç–∏ –¥–æ —Ñ–∏–Ω–∏—à–∞ –∏ –ø–æ–∫—Ä–∞—Å–∏—Ç—å —Ñ–∏–Ω–∏—à –≤ üåª."],
      "3.1": ["–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç–∞–∫, —á—Ç–æ–±—ã –≤—Å–µ 3 –ø–æ–ª—è –ø—Ä–æ—Ö–æ–¥–∏–ª–∏—Å—å —É—Å–ø–µ—à–Ω–æ."],
      "3.2": ["–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç–∞–∫, —á—Ç–æ–±—ã –≤—Å–µ 3 –ø–æ–ª—è –ø—Ä–æ—Ö–æ–¥–∏–ª–∏—Å—å —É—Å–ø–µ—à–Ω–æ."],
      "4.1": [
        "–ù–∞ –∫–∞–∂–¥–æ–º –ø–æ–ª–µ –¥–æ–π—Ç–∏ –¥–æ —Ñ–∏–Ω–∏—à–∞ –∏ –ø–æ–∫—Ä–∞—Å–∏—Ç—å —Ñ–∏–Ω–∏—à –≤ üåπ.",
        "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ—Ç –ø–æ 10 –ø–æ–ª—è–º.",
        "–û—Ç–∫—Ä—ã—Ç—ã 3 –ø–æ–ª—è, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∫—Ä—ã—Ç—ã."
      ]
    });

    const ROBOT_KEYBOARD_GROUPS = [
      ["üö∂", "üé®", "ü§î", "üîÅ", "üîÇ", "üòê"],
      ["‚úàÔ∏è", "üöá", "üö†", "üöú", "üß±", "üõ§", "üèÅ", "üéØ", "üå°", "üåπ", "üåª", "üçÄ", "üçá"],
      ["üü∞", "üö´", "üî•", "üßä", "üî•üü∞", "üßäüü∞", "0Ô∏è‚É£", "1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£", "9Ô∏è‚É£"]
    ];

    const ROBOT_SCENARIO_BLOBS = Object.freeze({
      "example:1": [{ "seed": 495056334, "blob": "tfdDppi8RkltK/Ril42uCOoE8quQU++yKp11S7hXteUHhrjNuKI2v+RgVFUIrUP4VeBE3WjSCY+Erq3rViJekVVIXC1HYdTWFSk6rXHDvNStzLR2ncfW+R3fRJWHXT6tx1t5XKprIbJ1Fd3TiDsYqQugHUI=" }],
      "example:2": [{ "seed": 3149492103, "blob": "/BgiFdFrN0pUFzWX7lp/a+Nrk7iZ5P7wM8L02OEghAbOqRk+8fUHPB6fFWaxehLb3M9lTuElmEwd8az4j5UvMpwBs8TJdGScbRt73sKavyyyJ1EuwSqYLCQQkRY5tAGKnjiLbSfMFj8DbQumKXTEnZuGLts5kifUGr959hkfMBUrmLSEW+v2hK2Y4gZVn7PxZOIzKVo9TSX7UBMAMbMIxAU8mPIiXd3TwC7WtnGs319FT+SCedJng8pgO3ENEtntKoozBlLi91OqjrUXUQxGo3Wyg7ZKskf5/YhYmKFlwkQI6BPmqRyQtM3/pHnu" }],
      "example:3": [{ "seed": 1508960576, "blob": "O70BQA4m5FezE3bCwWcMxuTOMM3mac3MFAd3rc49lyuJzHprLjhUobka1jNeB6G2W6qG+14obS/0Z5f8oFn9AOyzwUuO2FuBCgLiQbnoGtfqlKCfbf2/ThAlD6BP81vhAsUm+yHGiu+u7lQ4D8NNehxgUDuekQ84dPtllu7Gow==" }],
      "example:4": [{ "seed": 4163396345, "blob": "gibgv0cdVVCaGrcN2AzdIf010dLv8twKfUz2IjcWZkxw19tUZ0OjJtCRl/zHrHCRwpGnZNcz+vZTf67CWWMN+GIZ/zQYwMfPYhj5RL5CWfun/ZCOX22mGfnZj2xvxD0XPMjR0PQ2vjlJT5RyinJ9CMtEdvRdxII4zCE=" }],
      "example:5": [{ "seed": 2522864818, "blob": "yUvH6nzICl3BBPC4M9nynPaYduf0ByNHRvFxtxzjSZE7+jyBnJb7qwsMUIlseR9sSXzAkUwGQ6Mm0ZHm8oejep7Fh+F8tjWL+BRku8tWZA34Qma1fxPRxMJTCbodrQVbsPPgkZNoJOUc+NKCPT3zIA42ltGMvz+lL0Ri2WOY" }],
      "task:1.1": [{ "seed": 2850069356, "blob": "F/kNrBpasPPP1so+VetY4siKPCGSdTlpyMPrsXqxI09liHbHOgQAxQVeqg/Ki3XSN26KV2o0X1WmcDPRlITIe/dGkifFB6Jst1cEdzMl3LiSQv39ourD+kxWkv+iY/gUKRd8VS/sG10dLKhP0nxo3a0WU8g=" }],
      "task:1.2": [{ "seed": 2286936027, "blob": "oFy2CUX366640yE7mlazz58vJ8RtWALU34bAdPUsSGKSbY0iZWnaGDLbAYqFdt4/YIsRclVZJKgxNdiUm5ljlkDjKYIaqnmxQFJvcnyYt5VF5+aY3cf4R1uTubot/hM5XnIHJvYcQAcrhQKESCjTpmlJx/XKLJu5Lg==" }],
      "task:1.3": [{ "seed": 3625030526, "blob": "BecTVuisttm9OST0J72emDo0wjtAY7/Cmq0F+2hHZZV3lmh9CLIGL7dwhMV43TNohRA0TTgi3yF6jaWqxmPPftJp013oUokPBCgwd9+yiAm07tLpy/dNQJ6P/XbpCSlffB807QdMWGGgBIZOKZnfJELa4o14m702+pFXQAj8kQ==" }],
      "task:1.4": [{ "seed": 2640684229, "blob": "vkJM+7PxwdxWPutJzJDJPSHRPRZ73qiGsWiKZgNqknCMczcQ0283qhz1yzjTMGSNHjULIEPfTnqfm5KGLd85hF79U/BsrFNDLjwlgKreTef7mfzKy0FSlbX9c6hbOEkrQGy9FEAaKrUFq0g2nu5pFJfg2jDJqDa0gEU=" }],
      "task:2.1": [
        { "seed": 3514552160, "blob": "Gx3hoO6GxDdT8Val4cdsJsQuEC3Gye2tdOcXDS6dd4tpLFrLDlizAZu6NpM+Z4EWOwpmW75IDY/Uxrdt9ymSN/1TiT34EXsQZCXZtJBH/bfK1P+1BlaOrf10/kN2QHxDKfEbWhwRowyLTz+VvnFax+XKbpuiOviUS19p7oA0jGfanWAscEEb8A==" },
        { "seed": 1958263615, "blob": "RLC6/ZmDLzKcT72ItmJ3wzsDK5DRjMZo+3p8INl4jG42QYEWOd0ZhNRHnX5pghozBGcdpikN5snb2xyAQI0pkSL+UucPFBAVK5iymUfi5tK1+cQIEZOl6HLpFW4BJQcm9hxAByuUCIlEMpT4aRTB4tonleY1/5NRRELCgzeRN8KFMDtxB0Tw9Q==" },
        { "seed": 227708818, "blob": "6evnipxoKv0hppDfE3mSPBY4loeUpwPnZhFR1zyDaTFbmlwhvHaeyynscCmMGT8MaRzgMWzmo8XGcPE35TGMTo8ljxcKfxUr4eTQGdPI3K3B/Ehfhf+iTNdNbl4mVSX8BgtOOOQLgUkzgvQZS9Tzxyfd5mnij01SBqOKMpAsk9dRJngMFK+yZYh0WEmzqA==" }
      ],
      "task:2.2": [
        { "seed": 1465280969, "blob": "sraQj3dt5UDKisd6CJxtES2FgcK/Yox6DTymMsdmNlyAR2ukF/PSNoIBJ8wXPABhEuF3dIejrNhtnUaSXpJT4FT4eBJhelrn/d5I6/mc/ICjf27a//1v+gQvT3wfO70UQBoqtQW6QjuS9C5Kl6rbMMyhf7SbUVlD8oQYkSmPzTBzNhoD4eQojTMQSa2wXKOR+14oTT+gdfCRoFnnR7rvnkvX7GrCWkWgE7v5C5C+zf+kee4=" },
        { "seed": 1855547540, "blob": "78GVZHKiWKvn3mJh7WNAKpCSxOl67RERIMtDySI5W4ddcO4PkrwunW9WwlcyA20a73Yyn8KssXCAKuMp+0z+OIkPfX5kNeeM0Ant8Jzj0bseaKvxunLyESlYKgd65FBPHS2vHoB1P5D/I0vRspU2y7E2ut9eXkTonzO9KozQYGsuQR/o5CuVZh5H7LZVo46qRkltZvov6Ju8V7wcouWCRZbgacFHFbgL/uwckLWBoIRZ7qs=" },
        { "seed": 811088611, "blob": "mMR+Yb0fs4aweXmEEk57l4fX7yz1cHo81y64LH1UgFpq9UWK3UGHcDizWXINbhbneDPZ2s2xGp43j1iMJOYl5X4KFnwriIzQcLu5wtL/tQZQk7H0ZKhbF2ZyByXnAkwXN+RXkwU8mPIiXd3CyiParDby3wJDWPSJd9wjidF7OnwgCeHnNdgrHhKruVyglftIUVV4tDu5g7Yg5Uf4/YhZmKF/jxJXthO/5AKaos2422Phs1gWVRecUeY=" }
      ],
      "task:3.1": [
        { "seed": 2559271654, "blob": "nS97rgD0ntEVY5x8P3XGgML8KqNoG1fLMtVdcxCPXW3vXsDFIOppJ98ofE1gFetwPdic1dAa8TecZsUTvnr2GX0QZCXfqYxO7eHStdm7QlqYtOt/2AQtWDZAJL1IXQY2o0HKQTOf9ThG9v/DLcvmabSNTUVa7Yl5gzg=" },
        { "seed": 761306381, "blob": "diq0E+vZyXQOh2NRBMjRxek5pT4DNqAuyTACHstSauhE2484iwc9wkQNQyAb6Hw11p2TyHv3RpInwxq+ZacBHBYVK5i0hFvr9oStmOIGVZ+z8WTiMylaPU0l+1ATADGzCMQFPJjyIl3d08Au1rZxrN9IQljxgD7cOJ0=" },
        { "seed": 1596922632, "blob": "c+UJ+MaObG/rek5qud+U7iy2OFUuwUXVLG9vxRZl70PBlHKTZlDaWWEyLlvmfznek5KOY5ZA4ymCHLdluFAEdxNalvOZU/7wk/uAo18RkLT2fvkJHl4/Rij6FgtON7QYjQt4l/UlR8b47C3VqyG0xxpHX/OcN5tnncI=" }
      ],
      "task:3.2": [
        { "seed": 2053145287, "blob": "vFji1ZErd4oUVHXQrpq/K6MrU3jZJL4wcwK0GCHgRMaOadl+MbVAfFxfVaZxOtKbnI8ljiHlXpBT41SJDwQuLWvWot4R1cjcrcfhVFaVqbot8UMqUjBMM/cgTBUgrgiMBWCF7j5LmbLJK9etIP6+V1tF885h3DeF2zA0aQ==" },
        { "seed": 2900353402, "blob": "AbPPgjQwknU5bMjG67F6pD5Afo8831tvHtlpL6RLwYlzwjQp1C5kQzYkqDE00ZeUgSTIOYRe+0/+OIl+Cm8rYta9jwm0zq2jgPxcQ5O+7DWwGm5dN0sp7Bp7ESKlBY1DeMvoOVvQvI0k0Ko65ZV7WEbunnnEZ5LadmtpHg==" },
        { "seed": 1015939729, "blob": "6p6YJy/VbVgC09+CwHT1OVVtiWrHOgQCxQReqg/OjnTYL2PMTwtZLkrZP3TflJiJKsl/nD/7JOIl5X57YWpk372QWKyvq9KOu0FLhrj7Y6hbNxk4TC72AUEmJqcOgEI+06Y/XMD1g2DfrT3/jlB0Re2DKdx/ws13LTYeGw==" }
      ],
      "task:4.1": [
        { "seed": 617863868, "blob": "x8k9PMoqQGO/xZqpBftoUniabJEiZWnZGDPbAYqBc981eIZXajQ3VbdOep+am4Uix37aJ5okjyX2QEMhJHSY66d2oreV99L8R0fU5+M17AgiUi1NEvoTShwmok/SUyiE+WcM0/nBK8qsEPmRV0UIu84pmyHCwm8=" },
        { "seed": 3769890539, "blob": "kGwm2TUHe96ogbFsimYDf49/l3R9CLIEL7ZwhMV82DJinR1yVVlPqCALkdqVhi7PcNthgkWJUuYPFxBkXI79znbTudLsx/VIQNTnw0qmQylDLkAj61ATD2GgBIZOKZnOLk/W+Momm/4n5IhdGwjnhTWXNoj8fSV7EUS3qjWfdR4Wsw==" },
        { "seed": 1994858318, "blob": "NXfDJhg8xsntq3TiFw0uiGqEcisQ028zqh31yzjXNWWHBjhNOCKxP2Lg1NWILcN41WDEXehSjxIKfBUr4eLQGdO5q7uOqnlu2v/7cuYNPxlkfh2zUEwMM6MOnAVgir4tR9v53CrroTL1lV1TCLuYKYsgzJ10IHoKFeXLKJZ+Tkn090KqhvsZDg==" },
        { "seed": 1799528021, "blob": "LpI8CyOB0YzGbft/fCDZbZFhLUbLDli2AZi6NpM6YoAcIwcgQ98neoml28gjwHTdbsUb8DOPeBdhelqWis8Hv8ito4D6QV+arrot0TxgGTtdMPoRXVZ5vU+OTjSY7yN80PHMKtygcayJSkJPrc49lyuJzHoKew8J/6p92GNZD+yoTQ==" },
        { "seed": 2956188592, "blob": "y20RMJ6WlKcD72YVUdc8lnQ+QJ0WOd0dhNdHnX5thxs5HGpbvkhhkcuqxmPOd9Fmyxq2K+54fX9kNuf9px6ip63SjrtHVpqx6zWwOhEXfEA47xdKAGH8FspBM5/1OEbn9c4h0aE3tMdMRV/kwHmYLI7WYSFXDAri+mXAM04OqvdNsg==" },
        { "seed": 1288256335, "blob": "NEAqjYnTv2KMfA06pjLHcytTm0AhvHaYyyrscCmIHD4GcRGmKQ2I1MK3bY550mrDFLdt9hl9FnoriIzQcL25w9KOwhAfwoDFO6gCKVcyVmKlKXRYYaMVmEI5hb5xVZf2xizQtzvEmFlUQuSIecQxksp3ZTYFD+PhNJJSUwehpxL1wKsBFxRgpQ==" },
        { "seed": 452948066, "blob": "GXuXmsz4eu0RFiDOQ8kiLEaIRnekF/PXNoEBJ8wTOQFrCuwxbObO294cgDncac8cuWywARwWEzaW4KEH1afcvP+1fwba7MVKpkMvXjJJM71Icilv5AiQVz+S6GkUzrLJK9etIP6vXVZJ6Yk/3H+UzWcsOEEA5OYuiXl/BKK6Qu3Y+xYWUj+lKg==" },
        { "seed": 1539355737, "blob": "IsaA3+c99XB6OdcquCx9QZ1VcfIPkrwqnWxWwlc2BmwQ93t0h6PDxnLxN5xnzBCxYrFHBHcTXIj9zXbTudLsx/VIQNTnw0qmQylDLkAj61ATD2GgBIZOKZnOLk/W+Momm/4n5IhdGwjnhTWXNoj8fSV7EUS3qjWfdR4Wsw==" },
        { "seed": 1237619172, "blob": "n9HF9CKyaBtXwjLRXXMQmkBi9FmK3UGBcDuzWXIJaxftYD6fwqzSbZ9GkifCE71qv0ZCb3Jc4eLQGtO5q7mOq3lu2v/7cuYNPxlkfh2zUEwMM6MOnAVgir4tR9v53CrroTL1lV1TCLuYKYsgzJ10IHoKFeXLKJZ+Tkn090KqhvsZDg==" },
        { "seed": 2362389491, "blob": "iJTuMa0vAzagJsk1Ah7LR3fnX9zFIOpsJ94ofE1kEOp6JdXazbF2gC/jKYIdvma3SEMpaj3his0Hvcjc1Ja1Fm7ahq47uzwRF3xGJfMeWlZ5nTDEBT+J7C5NwbKVOZuiOviUS1945I04liCEnSg9ZhYDoaohk39VGKaWX6ONq0ZJFG+9M+jc8Q==" }
      ],
      "*": [{ "seed": 16355678, "blob": "JQcz9ghMVnmdXMQWB92+OFrU4ttgg59jus1lGwjnhTWXNoidKBIkT1bQpGWYfVMIpbBU7diCOV8Ufr07ptKuQcU4rP3XEcTmZdkKXeETuuIAnKOH0Jxl8L5YHFVQtV7uW/hd" }]
    });

    function decodeScenarioBlob(entry) {
      if (!entry || typeof entry !== "object") return "";
      const blob = String(entry.blob || "");
      const seed = Number(entry.seed) >>> 0;
      let encoded = "";
      try {
        encoded = atob(blob);
      } catch (_) {
        return "";
      }

      const bytes = new Uint8Array(encoded.length);
      let state = seed;
      for (let i = 0; i < encoded.length; i++) {
        const cipher = encoded.charCodeAt(i) & 0xff;
        bytes[i] = cipher ^ (state & 0xff);
        state = (state * 1664525 + 1013904223) >>> 0;
      }

      try {
        return new TextDecoder("utf-8").decode(bytes);
      } catch (_) {
        let fallback = "";
        for (let i = 0; i < bytes.length; i++) fallback += String.fromCharCode(bytes[i]);
        return fallback;
      }
    }

    function decodeScenarioMap(blobMap) {
      const out = {};
      const source = blobMap && typeof blobMap === "object" ? blobMap : {};
      const keys = Object.keys(source);
      for (const key of keys) {
        const encodedList = Array.isArray(source[key]) ? source[key] : [];
        const decoded = encodedList.map((entry) => decodeScenarioBlob(entry)).filter((text) => text.length > 0);
        if (decoded.length) out[key] = decoded;
      }
      return out;
    }

    function scenarioLabelFromKey(scenarioKey) {
      const key = String(scenarioKey || "");
      if (key.startsWith("example:")) {
        const n = key.slice("example:".length);
        return `–ü—Ä–∏–º–µ—Ä ‚Ññ${n}`;
      }
      if (key.startsWith("task:")) {
        const n = key.slice("task:".length);
        return `–ü–æ–¥–∑–∞–¥–∞—á–∞ ${n}`;
      }
      return "–°—Ü–µ–Ω–∞—Ä–∏–π";
    }

    function keyOf(x, y) {
      return `${x}:${y}`;
    }

    function clampCoord(value, maxValue) {
      const num = Number(value);
      if (!Number.isFinite(num)) return 0;
      const n = Math.trunc(num);
      return Math.max(0, Math.min(maxValue, n));
    }

    function setScenarioError(boardEl, metaEl, scenarioKey, message) {
      if (!boardEl || !metaEl) return;
      metaEl.textContent = `${scenarioLabelFromKey(scenarioKey)}: –æ—à–∏–±–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.`;
      boardEl.textContent = "";
      const errorEl = document.createElement("div");
      errorEl.className = "scenario-error";
      errorEl.textContent = String(message || "–°—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
      boardEl.appendChild(errorEl);
    }

    function cloneCells(cells, width, height) {
      const out = [];
      for (let y = 0; y < height; y++) {
        const row = [];
        for (let x = 0; x < width; x++) {
          const cell = cells && cells[y] && cells[y][x] ? cells[y][x] : null;
          row.push({
            color: cell && typeof cell.color === "string" ? cell.color : null,
            temp: cell && Number.isFinite(Number(cell.temp)) ? Math.trunc(Number(cell.temp)) : 0
          });
        }
        out.push(row);
      }
      return out;
    }

    function cloneBoardState(boardState) {
      return {
        width: boardState.width,
        height: boardState.height,
        start: boardState.start.slice(),
        finish: boardState.finish.slice(),
        robot: boardState.robot.slice(),
        blockedSet: new Set(boardState.blockedSet.values()),
        cells: cloneCells(boardState.cells, boardState.width, boardState.height),
        finishReached: Boolean(boardState.finishReached)
      };
    }

    function boardStateFromScenario(scenarioData) {
      const width = scenarioData.width;
      const height = scenarioData.height;
      const blockedSet = new Set();
      for (const item of scenarioData.blocked.values()) blockedSet.add(String(item));
      const start = scenarioData.start.slice();
      const finish = scenarioData.finish.slice();
      const robot = start.slice();
      return {
        width,
        height,
        start,
        finish,
        robot,
        blockedSet,
        cells: cloneCells(scenarioData.cells, width, height),
        finishReached: robot[0] === finish[0] && robot[1] === finish[1]
      };
    }

    function applySnapshotToBoardState(boardState, snapshot) {
      const out = cloneBoardState(boardState);
      if (!snapshot || typeof snapshot !== "object") return out;

      if (Array.isArray(snapshot.robot) && snapshot.robot.length === 2) {
        out.robot = [
          clampCoord(snapshot.robot[0], out.width - 1),
          clampCoord(snapshot.robot[1], out.height - 1)
        ];
      }

      if (Array.isArray(snapshot.blocked)) {
        const blockedSet = new Set();
        for (const pair of snapshot.blocked) {
          if (!Array.isArray(pair) || pair.length !== 2) continue;
          const x = Number(pair[0]);
          const y = Number(pair[1]);
          if (!Number.isFinite(x) || !Number.isFinite(y)) continue;
          const nx = Math.trunc(x);
          const ny = Math.trunc(y);
          if (nx < 0 || nx >= out.width || ny < 0 || ny >= out.height) continue;
          blockedSet.add(keyOf(nx, ny));
        }
        out.blockedSet = blockedSet;
      }

      if (Array.isArray(snapshot.cells)) {
        out.cells = cloneCells(snapshot.cells, out.width, out.height);
      }

      out.finishReached = out.robot[0] === out.finish[0] && out.robot[1] === out.finish[1];
      return out;
    }

    function normalizeTrace(trace, boardState) {
      const start = boardState.start.slice();
      const out = [start];
      if (!Array.isArray(trace)) return out;

      function pushPos(x, y) {
        const last = out[out.length - 1];
        if (last && last[0] === x && last[1] === y) return;
        out.push([x, y]);
      }

      for (const pair of trace) {
        if (!Array.isArray(pair) || pair.length !== 2) continue;
        const x = Number(pair[0]);
        const y = Number(pair[1]);
        if (!Number.isFinite(x) || !Number.isFinite(y)) continue;
        const nx = Math.trunc(x);
        const ny = Math.trunc(y);
        if (nx < 0 || nx >= boardState.width || ny < 0 || ny >= boardState.height) continue;
        pushPos(nx, ny);
      }

      return out;
    }

    function renderScenarioBoard(boardEl, metaEl, scenarioKey, boardState, phaseText) {
      if (!boardEl || !metaEl) return;
      boardEl.textContent = "";

      const width = boardState.width;
      const height = boardState.height;
      const start = boardState.start;
      const finish = boardState.finish;
      const robot = boardState.robot;
      const blockedSet = boardState.blockedSet;
      const cells = boardState.cells;
      metaEl.textContent = `${scenarioLabelFromKey(scenarioKey)}: –ø–æ–ª–µ ${width}x${height}, ${phaseText}`;

      const gridEl = document.createElement("div");
      gridEl.className = "scenario-grid";
      gridEl.style.gridTemplateColumns = `repeat(${width}, 38px)`;

      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const cellEl = document.createElement("div");
          cellEl.className = "scenario-cell";
          const blocked = blockedSet.has(keyOf(x, y));
          if (blocked) {
            cellEl.classList.add("blocked");
            cellEl.textContent = "‚ñ†";
          } else {
            const cell = cells[y][x];
            if (cell && cell.color && COLOR_CSS_BY_CODE[cell.color]) {
              cellEl.classList.add(COLOR_CSS_BY_CODE[cell.color]);
            }
            const temp = cell && Number.isFinite(Number(cell.temp)) ? Math.trunc(Number(cell.temp)) : 0;
            if (temp !== 0) {
              const tempEl = document.createElement("span");
              tempEl.className = "scenario-temp";
              tempEl.textContent = String(temp);
              cellEl.appendChild(tempEl);
            }
          }

          if (x === start[0] && y === start[1]) {
            const startEl = document.createElement("span");
            startEl.className = "scenario-marker start";
            startEl.textContent = "S";
            cellEl.appendChild(startEl);
          }

          if (x === finish[0] && y === finish[1]) {
            cellEl.classList.add("finish");
            const finishEl = document.createElement("span");
            finishEl.className = "scenario-marker finish";
            finishEl.textContent = "F";
            cellEl.appendChild(finishEl);
          }

          if (x === robot[0] && y === robot[1]) {
            const robotEl = document.createElement("span");
            robotEl.className = "scenario-marker";
            robotEl.textContent = "ü§ñ";
            cellEl.appendChild(robotEl);
          }

          gridEl.appendChild(cellEl);
        }
      }

      boardEl.appendChild(gridEl);
    }

    if (window.LovelaceLabShell && window.LovelaceDomains && typeof window.LovelaceDomains.createRobotDomain === "function") {
      const robotDomain = window.LovelaceDomains.createRobotDomain();
      const fixedTestsByScenario = decodeScenarioMap(ROBOT_SCENARIO_BLOBS);
      const scenarioMetaEl = document.getElementById("scenarioMeta");
      const scenarioBoardEl = document.getElementById("scenarioBoard");
      const scenarioAnimationToggleEl = document.getElementById("scenarioAnimationToggle");
      const ANIMATION_STEP_MS = 120;

      let lastScenarioPayload = null;
      let lastScenarioSnapshot = null;
      let lastScenarioTrace = null;
      let animationTimerId = 0;
      let animationToken = 0;

      function stopScenarioAnimation() {
        if (animationTimerId) {
          window.clearTimeout(animationTimerId);
          animationTimerId = 0;
        }
        animationToken += 1;
      }

      function isAnimationEnabled() {
        if (!scenarioAnimationToggleEl) return true;
        return scenarioAnimationToggleEl.checked;
      }

      function drawScenarioView(payload, snapshot, trace) {
        lastScenarioPayload = payload || null;
        lastScenarioSnapshot = snapshot || null;
        lastScenarioTrace = Array.isArray(trace) ? trace.slice() : null;
        const scenarioKey = payload && typeof payload.scenarioKey === "string" ? payload.scenarioKey : "";
        const tests = payload && Array.isArray(payload.tests) ? payload.tests : [];
        const scenarioText = tests.length ? String(tests[0] || "") : "";
        stopScenarioAnimation();

        if (!scenarioText) {
          setScenarioError(scenarioBoardEl, scenarioMetaEl, scenarioKey, "–°—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ –∑–∞–¥–∞–Ω.");
          return;
        }
        if (typeof robotDomain.parseScenario !== "function") {
          setScenarioError(scenarioBoardEl, scenarioMetaEl, scenarioKey, "–ü–∞—Ä—Å–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
          return;
        }
        const parsed = robotDomain.parseScenario(scenarioText);
        if (!parsed || !parsed.ok) {
          setScenarioError(scenarioBoardEl, scenarioMetaEl, scenarioKey, (parsed && parsed.error) || "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.");
          return;
        }

        const initialState = boardStateFromScenario(parsed.scenario);

        if (!snapshot) {
          renderScenarioBoard(scenarioBoardEl, scenarioMetaEl, scenarioKey, initialState, "–Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.");
          return;
        }

        const finalState = applySnapshotToBoardState(initialState, snapshot);
        const finalPhase = finalState.finishReached ? "–ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞: —Ñ–∏–Ω–∏—à –¥–æ—Å—Ç–∏–≥–Ω—É—Ç." : "–ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞: —Ñ–∏–Ω–∏—à –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç.";
        const tracePositions = normalizeTrace(trace, initialState);

        if (!isAnimationEnabled() || tracePositions.length < 2) {
          renderScenarioBoard(scenarioBoardEl, scenarioMetaEl, scenarioKey, finalState, finalPhase);
          return;
        }

        const token = animationToken;
        let frameIndex = 0;
        const lastIndex = tracePositions.length - 1;

        const renderNextFrame = () => {
          if (token !== animationToken) return;
          const frameState = cloneBoardState(initialState);
          frameState.robot = tracePositions[frameIndex].slice();
          frameState.finishReached = frameState.robot[0] === frameState.finish[0] && frameState.robot[1] === frameState.finish[1];
          const phase = `–∞–Ω–∏–º–∞—Ü–∏—è: —à–∞–≥ ${frameIndex}/${lastIndex}.`;
          renderScenarioBoard(scenarioBoardEl, scenarioMetaEl, scenarioKey, frameState, phase);

          if (frameIndex < lastIndex) {
            frameIndex += 1;
            animationTimerId = window.setTimeout(renderNextFrame, ANIMATION_STEP_MS);
            return;
          }

          animationTimerId = window.setTimeout(() => {
            if (token !== animationToken) return;
            renderScenarioBoard(scenarioBoardEl, scenarioMetaEl, scenarioKey, finalState, finalPhase);
            animationTimerId = 0;
          }, ANIMATION_STEP_MS);
        };

        renderNextFrame();
      }

      if (scenarioAnimationToggleEl) {
        try {
          if (window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
            scenarioAnimationToggleEl.checked = false;
          }
        } catch (_) {}
        scenarioAnimationToggleEl.addEventListener("change", () => {
          if (lastScenarioPayload) {
            drawScenarioView(lastScenarioPayload, lastScenarioSnapshot, lastScenarioTrace);
          }
        });
      }

      window.LovelaceLabShell.boot({
        domain: robotDomain,
        examples: ROBOT_EXAMPLES,
        taskSubtaskCounts: { "2": 2, "3": 2, "4": 1 },
        subtaskPresets: ROBOT_SUBTASK_PRESETS,
        subtaskTexts: ROBOT_SUBTASK_TEXTS,
        keyboardGroups: ROBOT_KEYBOARD_GROUPS,
        lineDigits: KEYCAP_DIGITS,
        maxTracePoints: 2200,
        fixedTestsByScenario,
        onScenarioChange(payload) {
          drawScenarioView(payload, null, null);
        },
        onRunComplete(payload) {
          const firstResult = payload && Array.isArray(payload.domainResults) ? payload.domainResults[0] : null;
          const snapshot = firstResult && firstResult.snapshot ? firstResult.snapshot : null;
          const trace = firstResult && Array.isArray(firstResult.trace) ? firstResult.trace : null;
          drawScenarioView(payload, snapshot, trace);
        }
      });
    }
  </script>
</body>
</html>
